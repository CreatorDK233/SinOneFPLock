C51 COMPILER V9.60.0.0   MAIN                                                              05/12/2023 14:54:18 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Softwares\Application\main.c LARGE OMF2 OPTIMIZE(9,SPEED) BROWSE INCDIR(
                    -.\Drivers\Lib\c;.\Drivers\Lib\H;.\Drivers\Lib\IAP_Lib;.\Drivers\Lib\TouchKey_lib;.\Drivers\Physical;.\Drivers\Protocol;.
                    -\Softwares\Application;.\Softwares\Basic;.\Softwares\ModuleLogic;.\Drivers\Protocol\YC_NFC;.\Drivers\Protocol\WIFI_Tuya)
                    - DEBUG PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "i2c.h"
   2          #include "usart.h"
   3          #include "spi.h"
   4          #include "tim.h"
   5          #include "IO.h"
   6          #include "LCD_HFG12864.h"
   7          #include <string.h>
   8          #include "RTC_PCF8563.h"
   9          #include "RTC.h"
  10          #include "adc.h"
  11          #include "BeepMgr.h"
  12          #include "Key_SinOne.h"
  13          #include "MFC_WS1850.h"
  14          #include "yc_nfc_contactless_l1.h"
  15          #include "TuyaWIFI.h"
  16          #include "GUI_Function.h"
  17          #include "Basic_Function.h"
  18          #include "Flash.h"
  19          #include "FingerPrint.h"
  20          #include "LEDsMgr.h"
  21          #include "Motor.h"
  22          #include "Battery.h"
  23          #include "HallSlide.h"
  24          #include "Log.h"
  25          #include "LowPower.h"
  26          #include "FP.h"
  27          #include "GUI.h"
  28          
  29          /**************************************************************
  30          说明：
  31          ***************************************************************/
  32          uint8_t ReadRTC = 0;
  33          uint8_t TextBuff[10]={0x11,0x22,0x33};
  34          extern void test_fun();
  35          
  36          //uint8_t system_IC_busy_Flag = 0;
  37          void Main_System_Init(void)
  38          {
  39   1        EnableWDT();
  40   1        MX_GPIO_Init();
  41   1        SET_MFC_RST_H;
  42   1        MX_ADC1_Init();
  43   1        MX_TIM_Init();
  44   1        MX_SPI0_Init();
  45   1        MX_UART2_Init();
  46   1        
  47   1        #ifdef Function_TuyaWifi
                //Wifi_Init();
                //MX_UART1_Init();
                Wifi_Rst();
                #endif
  52   1        
C51 COMPILER V9.60.0.0   MAIN                                                              05/12/2023 14:54:18 PAGE 2   

  53   1        FPcmd_Init();
  54   1        MX_I2C_Init();
  55   1        SYSPOWER_ON;  
  56   1        #ifdef Function_USE_External_RTC
                PCF8563_Init();
                Hardware_DelayMs(10);
                #endif  
  60   1        FPMpowerMgr.Status = FPMpowerOn;
  61   1        VOICE_Init();
  62   1        MFC_Init();
  63   1        Hardware_DelayMs(10);
  64   1        Touch_Init();
  65   1        AwakeSystemKeyMgr.IsDoorBellKeyAwake = bFALSE;
  66   1        AwakeSystemKeyMgr.IsPoundsignKeyAwake = bFALSE;
  67   1        Hardware_DelayMs(10);
  68   1        SystemTime.year   =   0x20;
  69   1        SystemTime.month  =   1;
  70   1        SystemTime.date   =   1;
  71   1        SystemTime.day    =   3;
  72   1        SystemTime.hour     =   0;
  73   1        SystemTime.minute   =   0;
  74   1        SystemTime.second   =   0;
  75   1        #ifdef Function_USE_Internal_RTC
                G_SystemUTCTime = SystemTimeToUTC(SystemTime);
                #elif defined Function_USE_External_RTC
                PCF8563_WriteTime();
                #endif
  80   1        GUI_Init();
  81   1        
  82   1        SafetyMonitorMgr.FpIdentifyFailedTimes = 0;
  83   1        SafetyMonitorMgr.CardIdentifyFailedTimes = 0;
  84   1        SafetyMonitorMgr.PasscodeIdentifyFailedTimes = 0;
  85   1        SafetyMonitorMgr.ManagerPasscodeIdentifyFailedTimes = 0;
  86   1        SafetyMonitorMgr.SystemLocked = bFALSE;
  87   1        UserIdentifyResultMgr.FlagContinuedOpenEnabled = bFALSE;
  88   1        
  89   1        /* Configure The Touch*/
  90   1        #ifdef Function_EventLog
                LogMgr_Init();
                #endif
  93   1        /* Configure The Motor*/
  94   1        Hardware_MotorMgr_Init();
  95   1        
  96   1        CurrentScreen = SCREEN_Initialization;
  97   1        InitializationMgr.Status = StartInitialization;
  98   1        BatteryMgr.ProtectVoltageTriggerTimes = 0;
  99   1        BatteryMgr.LowBatteryProtectionEnabled = bFALSE;
 100   1        BatteryMgr.BatteryVoltage = 0;
 101   1        VoiceMgr.volume = 20; // default volume
 102   1        SET_VOLUME(VoiceMgr.volume);
 103   1        
 104   1        AntiPryingMgr.AntiPryingTrigger = bFALSE;
 105   1        AntiPryingMgr.AntiPryingSignalRelease = bFALSE; 
 106   1        #ifdef Function_HallSlide
                HallSlideCover_Init();
                #endif
 109   1        #ifdef Function_TuyaWifi
                WifiMgr.PowerState = WIFIPowerClosed;
                #endif
 112   1        RefreshSystemSleepTime();
 113   1      }
 114          void main(void)
C51 COMPILER V9.60.0.0   MAIN                                                              05/12/2023 14:54:18 PAGE 3   

 115          {
 116   1        uint8_t i;
 117   1        uint32_t Awake_key=0;
 118   1        
 119   1        FLASH_OB_Config();      //v121和中微有差异
 120   1        Main_System_Init();
 121   1        
 122   1        for (i = 0; i < 50; i++) 
 123   1        {
 124   2            Hardware_Task_Analog();
 125   2            HardwareBatteryMgr_Task();
 126   2        } //更新50次ADC
 127   1        
 128   1        #ifdef Function_FPMbreathingLed
 129   1        SetFPMbreathingLed(FPMbreathingLed_Bule);
 130   1        #endif
 131   1        Hardware_MotorMgr_Init(); //电机初始化
 132   1        
 133   1        while (1)
 134   1        {
 135   2          if ( G_tflagbits.T1024Hz == 1 )
 136   2          {
 137   3            G_tflagbits.T1024Hz =0;
 138   3          }
 139   2      
 140   2          if ( G_tflagbits.T256Hz == 1 )
 141   2          {
 142   3            G_tflagbits.T256Hz =0;      
 143   3          }
 144   2          
 145   2          if ( G_tflagbits.T64Hz == 1 )
 146   2          {
 147   3            G_tflagbits.T64Hz = 0;
 148   3        
 149   3            FPM_Mgr_Task();
 150   3            
 151   3            #if defined (Function_TuyaWifi)
                    Wifi_Mgr_Task();
                    #endif
 154   3      
 155   3            GUI_Task();
 156   3            
 157   3            Hardware_MotorMgr_Task(); 
 158   3      
 159   3            #if (defined ProjectIs_BarLock_S7702) || (defined ProjectIs_BarLock_S4914)
 160   3            LEDsMgr_Task();
 161   3            #endif
 162   3      
 163   3            if ( SystemPowerMgr.SleepDelayTimerCnt > 0 )
 164   3            {
 165   4              SystemPowerMgr.SleepDelayTimerCnt--;
 166   4            }
 167   3            
 168   3            if (SystemPowerMgr.AwakeTimerCnt < 60)
 169   3            {
 170   4              SystemPowerMgr.AwakeTimerCnt++;
 171   4            }
 172   3            #ifdef Function_HallSlide
                    HallSleep_Task();
                    #endif
 175   3            if (( MotorMgr.MotorStatus == IDLE )
 176   3              //&&( PINMACRO_KB_IRQ_STATUS != 0x00 )   
C51 COMPILER V9.60.0.0   MAIN                                                              05/12/2023 14:54:18 PAGE 4   

 177   3              &&( CurrentScreen != SCREEN_Initialization )
 178   3              &&( CurrentScreen != SCREEN_PickLockAlarm )
 179   3              &&( CurrentScreen != SCREEN_SystemLocked )
 180   3              &&( CurrentScreen != SCREEN_AgingTest )
 181   3      //        &&(CurrentScreen != SCREEN_SelfTest)
 182   3              &&((SystemPowerMgr.SleepDelayTimerCnt == 0x0000)  
 183   3                ) //casing closed
 184   3              )
 185   3            {
 186   4              System_PowerDown();
 187   4              System_Awake();
 188   4              CLRWDT();
 189   4              RefreshSystemSleepTime();
 190   4              SystemPowerMgr.AwakeTimerCnt=0x0000;
 191   4            }
 192   3          }
 193   2          
 194   2      //    if ( G_tflagbits.T16Hz == 1 )
 195   2      //    {
 196   2      //      
 197   2      //    }
 198   2          
 199   2          if ( G_tflagbits.T8Hz == 1 )
 200   2          {
 201   3            G_tflagbits.T8Hz =0;
 202   3            CLRWDT();
 203   3            #ifdef Function_ScreenDisplay
                    //if(system_IC_busy_Flag == 0)
                    {
                      for(i=0;i<8;i++)
                      { 
                        Display_Task();
                      }
                    }
                    #endif  
 212   3            //Uart3SendStr(TextBuff,3);
 213   3          }
 214   2      
 215   2          if ( G_tflagbits.T2Hz == 1 )
 216   2          {
 217   3            G_tflagbits.T2Hz =0;
 218   3          }
 219   2          
 220   2          if ( G_tflagbits.T1Hz == 1 )
 221   2          {
 222   3            G_tflagbits.T1Hz =0;
 223   3            //SystemTimeUpdate(); 
 224   3            #ifdef Function_TuyaWifi      
                    WifiRemoteUnlockCountdown();
                    #endif
 227   3      
 228   3            //EEPROM_TESTING();
 229   3            //MFC_Test();
 230   3            //Flash_Test();
 231   3            //AppUnlockTest();
 232   3            #ifdef Function_USE_Internal_RTC
                    SystemTime = UTCToSystemtime(G_SystemUTCTime);
                    #elif defined Function_USE_External_RTC
                    if( ReadRTC == 0 )
                    {
                      PCF8563_ReadTime();
                    }
C51 COMPILER V9.60.0.0   MAIN                                                              05/12/2023 14:54:18 PAGE 5   

                    ReadRTC += 1;
                    if(ReadRTC >= 5)
                    ReadRTC = 0;
                    #endif
 243   3            DEBUG_MARK;
 244   3            
 245   3          }
 246   2        }
 247   1      }
 248          
 249          
 250          
 251          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    425    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     11       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
