C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE LOWPOWER
OBJECT MODULE PLACED IN .\Objects\LowPower.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Softwares\Application\LowPower.c LARGE OMF2 OPTIMIZE(9,SPEED) BROWSE INC
                    -DIR(.\Drivers\Lib\c;.\Drivers\Lib\H;.\Drivers\Lib\IAP_Lib;.\Drivers\Lib\TouchKey_lib;.\Drivers\Physical;.\Drivers\Protoc
                    -ol;.\Softwares\Application;.\Softwares\Basic;.\Softwares\ModuleLogic;.\Drivers\Protocol\YC_NFC;.\Drivers\Protocol\WIFI_T
                    -uya) DEBUG PRINT(.\Listings\LowPower.lst) TABS(2) OBJECT(.\Objects\LowPower.obj)

line level    source

   1          #include "LowPower.h"
   2          #include "SensorMethod.h"
   3          #include "Project.h"
   4          #include "IO.h"
   5          #include "global_variable.h"
   6          #include "Basic_Function.h"
   7          #include "HallSlide.h"
   8          /*以下为休眠唤醒函数所需头文件*/
   9          #include "spi.h"
  10          #include "adc.h"
  11          #include "KeyScan.h"
  12          #include "GUI.h"
  13          #include "i2c.h"
  14          #include "Fingerprint.h"
  15          #include "MFC_WS1850.h"
  16          #include "yc_nfc_contactless_l1.h"
  17          #include "BeepMgr.h"
  18          #include "tim.h"
  19          #include "usart.h"
  20          #include "RTC_PCF8563.h"
  21          #include "LCD.h"
  22          #include "Battery.h"
  23          
  24          #include "TuyaWIFI.h"
  25          
  26          extern bool_t IfSystemIsInFactoryDefaultStatus(void);
  27          
  28          extern uint8_t LEDsCtrlSwitch;
  29          extern bit Touch_WakeUpFlag;
  30          #ifdef Function_HallSlide
              extern  bit SleepingHallState;  //休眠时读到霍尔io口的电位值
              extern bit HallSleepFlag;       //霍尔休眠标志
              #endif
  34          
  35          #ifdef Function_USE_Internal_RTC
              unsigned  char  SecondCount = 0;
              #endif
  38          
  39          uint8_t LastWakeUpKeyValue;
  40          bit     KeyJustWakeUp = 0;
  41          
  42          /**************************************************
  43          *函数名称：void IntoLowPowerMode_Init(void)
  44          *函数功能：进入低功耗模式前的的初始化
  45          *入口参数：void
  46          *出口参数：void  
  47          *备注说明：在进入低功耗前，对部分数据进行处理 
  48          **************************************************/
  49          void IntoLowPowerMode_Init(void)
  50          {
  51   1          /*进入低功耗前设置*/
  52   1        #ifdef Function_HallSlide
C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 2   

                SleepingHallState = PINMACRO_HALLSENSOR_STATUS;
                HallSleepFlag = 0;
                #endif
  56   1      }
  57          
  58          /**************************************************
  59          *函数名称：void MX_QuitLowPowerMode(void)
  60          *函数功能d退出低功耗模式
  61          *入口参数：void
  62          *出口参数：void  
  63          **************************************************/
  64          void MX_QuitLowPowerMode(void)
  65          {
  66   1        TouchKey_QuitLowPowerMode();       
  67   1        Touch_WakeUpFlag = 1; 
  68   1      }
  69          
  70          /**************************************************
  71          *函数名称：void AntiMisAwakeup(uint8_t KeyValue)
  72          *函数功能d防止偶然干扰造成自动唤醒
  73          *入口参数：uint8_t KeyValue
  74          *出口参数：void  
  75          **************************************************/
  76          void AntiMisAwakeup(uint8_t KeyValue)
  77          {
  78   1        if(LastWakeUpKeyValue==KeyValue)
  79   1        {
  80   2          #ifdef Function_HallSlide
                  if( PINMACRO_HALLSENSOR_STATUS == 0 )
                  {
                    MX_QuitLowPowerMode();
                    KeyJustWakeUp = 1;
                  }
                  LastWakeUpKeyValue = 0xff;
                  #else
  88   2          MX_QuitLowPowerMode();
  89   2          KeyJustWakeUp = 1;
  90   2          LastWakeUpKeyValue = 0xff;
  91   2          #endif
  92   2        }
  93   1        else{
  94   2          LastWakeUpKeyValue = KeyValue;
  95   2        }
  96   1      }
  97          
  98          /**************************************************
  99          *函数名称：void LowPowerAwakeupDispose(void)
 100          *函数功能d低功耗唤醒检测（不带触摸按键检测）
 101          *入口参数：void
 102          *出口参数：void  
 103          **************************************************/
 104          void LowPowerAwakeupDispose(void)
 105          {
 106   1        if( PickAlarmEnableMgr.Enable == bTRUE )
 107   1        {
 108   2          if(( PINMACRO_PICKLOCK_STATUS == 1 )&&( AntiPryingMgr.AntiPryingSignalRelease == bTRUE ))
 109   2          {
 110   3            MX_QuitLowPowerMode();
 111   3          }
 112   2        }
 113   1        if(( PINMACRO_FPM_TOUCH_STATUS == 1 )||( PINMACRO_ONBOARD_BUTTON_STATUS == 0 ))
 114   1        {
C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 3   

 115   2          MX_QuitLowPowerMode();
 116   2        }
 117   1        #ifdef Function_HallSlide
                HallAwakeupDispose();
                #endif
 120   1        if( INT1flag != 0 )
 121   1        {
 122   2          INT1flag=0x00;
 123   2          MX_QuitLowPowerMode();
 124   2        }
 125   1      }
 126          
 127          /**************************************************
 128          *函数名称：void System_PowerDown(void)
 129          *函数功能d系统休眠开始
 130          *入口参数：void
 131          *出口参数：void  
 132          **************************************************/
 133          void System_PowerDown(void)
 134          {
 135   1        uint16_t i;
 136   1        //uint8_t j=0,k=0;
 137   1        //uint32_t Awake_key=0;
 138   1        
 139   1        static uint16_t FPtimeout_times,FP_SleepFailedTimes;
 140   1        
 141   1        CLRWDT();
 142   1        DEBUG_MARK;
 143   1        
 144   1        #ifdef Function_ScreenDisplay
                Clear_Screen();
                #endif
 147   1        
 148   1        #ifndef DEBUG_MODE
 149   1        SET_LOGLED_OFF;
 150   1        #endif
 151   1        
 152   1        ADC_DeInit();
 153   1        
 154   1        MX_TIM_DeInit();
 155   1      
 156   1        SPI0_DeInit();
 157   1      
 158   1        MFC_POWERDOWN();
 159   1      
 160   1        VoicePlayerPowerDown();
 161   1      
 162   1        CLRWDT();
 163   1      
 164   1        FPtimeout_times=0;
 165   1        FP_SleepFailedTimes=0;
 166   1        while(1)
 167   1        {
 168   2          FpmAckMgr.Status = WaitACK;
 169   2          FPM_SendSleepCmd();
 170   2          for (i=0;i<25;i++)
 171   2          {
 172   3            CLRWDT();
 173   3            Hardware_DelayMs(20);
 174   3            FPM_Mgr_Task();
 175   3            if ( FpmAckMgr.Status == GotACK )
 176   3            {
C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 4   

 177   4              if (  ( FpmAckMgr.ErrorCode == Error_NONE)
 178   4                &&(PINMACRO_FPM_TOUCH_STATUS == 0 )
 179   4                )
 180   4              {
 181   5                FPMpowerMgr.Status = FPMpowerDown;  
 182   5                DEBUG_MARK;
 183   5                break;
 184   5              }
 185   4              else
 186   4              {
 187   5                FP_SleepFailedTimes++;
 188   5                DEBUG_MARK;
 189   5                
 190   5                if (FP_SleepFailedTimes>350)    //FP not released more than 10s
 191   5                {
 192   6                  FPMpowerMgr.Status = FPMpowerDown;  
 193   6                }
 194   5                break;
 195   5              }
 196   4              
 197   4            }
 198   3            else
 199   3            {
 200   4              if (i>23)   //time out,FP failed
 201   4              {
 202   5                FPtimeout_times++;
 203   5                if (FPtimeout_times>2)
 204   5                {
 205   6                  FPMpowerMgr.Status = FPMpowerDown;  
 206   6                  break;
 207   6                }
 208   5              }
 209   4            }
 210   3          }
 211   2          CLRWDT();
 212   2          if ( FPMpowerMgr.Status == FPMpowerDown)
 213   2          {
 214   3            DEBUG_MARK;
 215   3            MX_UART2_DeInit();
 216   3            SET_FPMPOWER_OFF; 
 217   3            Hardware_DelayMs(3);//Wait for Power line lost power
 218   3            break;
 219   3          }
 220   2        }
 221   1        #ifdef ProjectIs_BarLock_S7702
                  LEDsCtrlSwitch = 0;
                #endif
 224   1          //wait for user release touch button
 225   1        if ( SystemPowerMgr.SleepSource == UserForced )
 226   1        {
 227   2          for (i=0;i<10;i++)
 228   2          {
 229   3            CLRWDT();
 230   3            Hardware_DelayMs(1);
 231   3          }
 232   2        }
 233   1        #ifdef Function_TuyaWifi
 234   1        if( WifiMgr.PostMgr.RemoteUnlockCountdown > 0 )
 235   1        {
 236   2          WifiRemoteUnlockStop();
 237   2        }
 238   1        while( WifiMgr.PowerState == WIFIPowerOpened )
C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 5   

 239   1        {
 240   2          Wifi_Mgr_Task();
 241   2          Hardware_DelayMs(16);
 242   2          CLRWDT();
 243   2        }
 244   1        #endif
 245   1      
 246   1        MX_GPIO_DeInit();
 247   1        
 248   1        Enable_EX_Interrupt();
 249   1        
 250   1        IntoLowPowerMode_Init();
 251   1      
 252   1        TouchKey_IntoLowPowerMode();
 253   1        i=0;
 254   1        while(i!=1)
 255   1        {
 256   2          if(GetLowPowerScanFlag() == 0)  //正常运行模式 
 257   2          {
 258   3            i=1;
 259   3          }
 260   2          else            //低功耗运行模式
 261   2          {
 262   3            LowPower_Touchkey_Scan();
 263   3          } 
 264   2        }
 265   1      }
 266          
 267          /**************************************************
 268          *函数名称：void System_Awake(void)
 269          *函数功能d系统唤醒开始
 270          *入口参数：void
 271          *出口参数：void  
 272          **************************************************/
 273          void System_Awake(void)
 274          {
 275   1        uint8_t i;
 276   1        
 277   1        CLRWDT();
 278   1      
 279   1        Hardware_DelayMs(1);    //wait for system clock stable//
 280   1        
 281   1        MX_GPIO_Init();
 282   1        
 283   1        SET_MFC_RST_H;
 284   1        
 285   1        MX_ADC1_Init();
 286   1        
 287   1        MX_TIM_Init();
 288   1        
 289   1        MX_SPI0_Init();
 290   1        
 291   1        MX_I2C_Init();
 292   1        
 293   1        #ifndef DEBUG_MODE
 294   1        SET_LOGLED_ON;
 295   1        #endif
 296   1        
 297   1        #if (defined ProjectIs_BarLock_S7702)
                SET_LEDKEYs_OFF;
                #endif
 300   1        
C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 6   

 301   1      //  #ifdef Function_TuyaWifi
 302   1      //  //Wifi_Init();
 303   1      //  Wifi_Rst();
 304   1      //  #endif
 305   1        
 306   1        MX_UART2_Init();
 307   1        
 308   1        SET_POWER_ON;        
 309   1        FPMpowerMgr.Status = FPMpowerOn;
 310   1        Hardware_DelayMs(5);    //wait for OLED Driver power on reset
 311   1        
 312   1        MFC_Init();
 313   1        Hardware_DelayMs(5);  
 314   1        
 315   1        TouchKeyRestart();
 316   1        Key_Init();
 317   1        
 318   1        GUI_Init(); 
 319   1      
 320   1        SET_VOLUME(VoiceMgr.volume);
 321   1      
 322   1        Hardware_DelayMs(1);
 323   1        
 324   1        for (i=0;i<100;i++)
 325   1        {
 326   2          if( i%10 == 0 )CLRWDT();
 327   2          Hardware_Task_Analog();
 328   2          HardwareBatteryMgr_Task();
 329   2        }
 330   1        
 331   1        if (( BatteryMgr.BatteryLevel == LEVEL_1 )||( BatteryMgr.BatteryLevel == LEVEL_0 ))
 332   1        {
 333   2          PLAY_VOICE_ONESEGMENT(VOICE_PleaseReplaceTheBattery);
 334   2          BatteryMgr.TimeCnt = Def_MessageBoxTimeDelay;
 335   2          CurrentScreen = SCREEN_LowBattery;    
 336   2        }
 337   1        #ifdef INSIDEBUTTONINTOMAINMENU
                else if (SystemPowerMgr.AwakeSource == SystemResetKey)    
                {
                  if ( PINMACRO_ONBOARD_BUTTON_STATUS != 0 )
                  {
                    //TouchKeyStatus.KEY_INSIDEBUTTON_Pressed = bTRUE;
                    //SystemPowerMgr.AwakeSource = DoNotCare; 
                    CurrentScreen = SCREEN_ManagerIdentify;
                    ManagerIdentifyMgr.Status = StartManagerIdentify;
                  }
              
                } 
                #endif
 350   1        else
 351   1        {
 352   2          CurrentScreen = SCREEN_Main;
 353   2          PasscodeUserIdentifyMgr.Status = PasscodeIdentifyIdle;
 354   2          FpIdentifyMgr.Status = FPMcmdStart;
 355   2          CardIdentifyMgr.Status = ReadingCardID;
 356   2          if ( IfSystemIsInFactoryDefaultStatus()==bTRUE )
 357   2          {
 358   3            PLAY_VOICE_ONESEGMENT(VOICE_PleaseAddMasterFirst);
 359   3          }
 360   2          else
 361   2          {
 362   3            if (  (SystemPowerMgr.AwakeSource == CasingOpen)
C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 7   

 363   3              ||(SystemPowerMgr.AwakeSource == KeyBoardTouch)
 364   3              )
 365   3            {
 366   4              PLAY_VOICE_ONESEGMENT_FIXED(VOICE_POWERON); 
 367   4            }
 368   3          }
 369   2        }
 370   1        
 371   1        SystemPowerMgr.SleepSource = SleepTimer;
 372   1      
 373   1      #ifdef Function_FPMbreathingLed
 374   1        for(i=0;i<25;i++)
 375   1        {
 376   2          CLRWDT();
 377   2          FpmAckMgr.Status = WaitACK;
 378   2          FPM_SetBreathingLED(1,1,1,255);   //Blue LED breathing
 379   2          Hardware_DelayMs(20);
 380   2          FPM_Mgr_Task();
 381   2          if ( FpmAckMgr.Status == GotACK )
 382   2          {
 383   3            break;
 384   3          }
 385   2        }
 386   1      #endif
 387   1        
 388   1      }
 389          
 390          /**************************************************
 391          *函数名称：void LowPowerTimer_ISR(void)
 392          *函数功能d低功耗模式下定时器中断服务函数（125ms调用一次）
 393          *入口参数：void
 394          *出口参数：void  
 395          **************************************************/
 396          void LowPowerTimer_ISR(void) 
 397          {
 398   1        #ifdef Function_USE_Internal_RTC
                SecondCount += 1;
                if( SecondCount >= 8 )
                {
                  SecondCount = 0;
                  G_SystemUTCTime += 1;
                }
                #endif
 406   1      }
 407          
 408          
 409          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    748    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      5       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.60.0.0   LOWPOWER                                                          04/19/2023 13:57:32 PAGE 8   


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
