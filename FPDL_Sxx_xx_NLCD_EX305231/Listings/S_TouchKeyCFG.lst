C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE S_TOUCHKEYCFG
OBJECT MODULE PLACED IN .\Objects\S_TouchKeyCFG.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Drivers\Lib\TouchKey_lib\S_TouchKeyCFG.C LARGE OMF2 OPTIMIZE(9,SPEED) BR
                    -OWSE INCDIR(.\Drivers\Lib\c;.\Drivers\Lib\H;.\Drivers\Lib\IAP_Lib;.\Drivers\Lib\TouchKey_lib;.\Drivers\Physical;.\Driver
                    -s\Protocol;.\Softwares\Application;.\Softwares\Basic;.\Softwares\ModuleLogic;.\Drivers\Protocol\YC_NFC;.\Drivers\Protoco
                    -l\WIFI_Tuya) DEBUG PRINT(.\Listings\S_TouchKeyCFG.lst) TABS(2) OBJECT(.\Objects\S_TouchKeyCFG.obj)

line level    source

   1          //*************************************************************************************************
   2          //  Copyright (c)   ÉîÛÚÊÐÈüÔªÎ¢µç×ÓÓÐÏÞ¹«Ë¾
   3          //  ÎÄ¼þÃû³Æ  :  S_TouchKeyCFG.c
   4          //  ×÷Õß    : 
   5          //  Ä£¿é¹¦ÄÜ  :  
   6          //  °æ±¾    :
   7          //  ¸ü¸Ä¼ÇÂ¼  :
   8          //  ×¢ÒâÊÂÏî  :  ÓÃ»§ÐèÒªÅäÖÃµÄÎÄ¼þÔÚS_TouchKeyCFG.hÖÐ
   9          //  ¿â°æ±¾±ê¼Ç  : 
  10          //************************************************************************************************
  11          #include "S_TouchKeyCFG.h"
  12          #include "SC95F861xB_C.H"
  13          #include "LowPower.h"
  14          
  15          
  16          /***************ÐÍºÅÑ¡Ôñ***************/
  17          #define  SC95F8X3X      1 
  18          #define  SC92F8X8X      2
  19          #define  SC92F8X9X      3
  20          #define  SC92L8X3X      4
  21          #define  SC95F8X6X      5
  22          #define  SC95F8X1XB     6
  23          #define  SC95R605       7
  24          #define  MCU_TYPE   SC95R605    
  25          bit H_FLAG;
  26          //*************************************************************************************
  27          //     ¼Ä´æÆ÷¶¨Òå
  28          //*************************************************************************************
  29          
  30          /*PSW*/
  31          sfr   TK_PSW      =   0xD0;             //³ÌÐò×´Ì¬×Ö
  32          sbit  TK_CY   =   TK_PSW^7;           //½øÎ»  
  33          
  34          sfr   TK_IE1      =   0xA9;             //ÖÐ¶Ï¿ØÖÆ¼Ä´æ
  35          /*system*/
  36          //sfr   PCON      =   0x87;             //µçÔ´¹ÜÀí¿ØÖÆ¼Ä´æÆ÷
  37          
  38          //sfr   TKCR  = 0xE8;               //TouchKey¿ØÖÆ¼Ä´æÆ÷
  39          
  40          sfr   TKTMH = 0xE7;               //´¥Ãþ°´¼ü¶¨Ê±¼Ä´æÆ÷L
  41          sfr   TKTML = 0xE6;               //´¥Ãþ°´¼ü¶¨Ê±¼Ä´æÆ÷L
  42          sfr16   TKTM    =   0xE6;
  43          
  44          sfr   TKCNTH  = 0xE5;               //TouchKey¼ÆÊýÆ÷Öµ¸ß7Î»
  45          sfr   TKCNTL  = 0xE4;               //TouchKey¼ÆÊýÆ÷ÖµµÍ8Î»
  46          sfr16   TKCNT   =   0xE4;
  47          
  48          sfr   TKCFG2  = 0xE3;               //´¥Ãþ°´¼ü²Î¿¼µçÑ¹ÅäÖÃ¼Ä´æÆ÷
  49          sfr   TKCFG1  = 0xE2;               //TouchKeyÅäÖÃ¼Ä´æÆ÷2
  50          sfr   TKCFG0  = 0xE1;               //TouchKeyÅäÖÃ¼Ä´æÆ÷1
  51          
  52          /*TKCR*/
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 2   

  53          //sbit  ENTKS = TKCR^7;               //TouchKey¿ª¹ØµçÔ´
  54          sbit  TRIG  = TKCR^6;               //TouchKey´¥·¢¿ª¹Ø£ºÐ´1ÓÐÐ§£¬´¥·¢Ò»´ÎkeyÉ¨ÃèÖÜÆÚ
  55          sbit  TRIF  = TKCR^5;               //TouchKeyÖÐ¶Ï±êÖ¾
  56          
  57          //===========================================================================
  58          //È«¾Ö±äÁ¿¶¨Òå
  59          unsigned  char  xdata   SOCAPI_TouchKeyStatus;  //API½Ó¿Ú×´Ì¬£ºbit7-Ò»ÂÖÉ¨ÃèÍê³É±êÖ¾  1:Íê³É  0£ºÎ´Íê³É
  60                                      //         bit6-Í¨µÀ´¥Ãþ¼ÆÊýÒç³ö±êÖ¾ 1:Òç³ö  0:Î´Òç³ö
  61          //===============================================================================
  62          //È«¾Ö±äÁ¿ÉùÃ÷£º¸ÃÇøÓò²»¿ÉÐÞ¸Ä
  63          unsigned  int   xdata   RawData [SOCAPI_SET_TOUCHKEY_TOTAL];      
  64          unsigned  int   data    BaseLine[SOCAPI_SET_TOUCHKEY_TOTAL];
  65          unsigned    int   xdata   FilterData[SOCAPI_SET_TOUCHKEY_TOTAL];                        
  66          unsigned  char    xdata   RestAreaCnt[SOCAPI_SET_TOUCHKEY_TOTAL];       
  67          unsigned  char    xdata   TouchCnt[SOCAPI_SET_TOUCHKEY_TOTAL];        
  68          unsigned  char    xdata   NoTouchCnt[SOCAPI_SET_TOUCHKEY_TOTAL];        
  69          unsigned  char  xdata   CurrentChannel[SOCAPI_SET_TOUCHKEY_TOTAL];                 
  70          unsigned    char    xdata       LowFingerDataCnt[SOCAPI_SET_TOUCHKEY_TOTAL];
  71          unsigned  char    xdata   FloatAreaCnt[SOCAPI_SET_TOUCHKEY_TOTAL]; 
  72          unsigned  char  xdata       BaseLineAdjusttmp[SOCAPI_SET_TOUCHKEY_TOTAL];   
  73          int                 xdata       DifferAccum[SOCAPI_SET_TOUCHKEY_TOTAL]; 
  74          char              xdata   SetNoiseThreshold;
  75          unsigned  char  xdata   ConfirmTouchCnt;
  76          unsigned  char  xdata   MultipleDealTpye = 0; 
  77          
  78          //×Ô¶¨Òå±äÁ¿
  79          unsigned  int   xdata       UpdateBaseLNum;         // µ¥¼ü³¤°´¼ÆÊýÆ÷
  80          unsigned  int   xdata       MultipleLNum;         // ¶à°´¼ü¸ÉÈÅ¼ÆÊý
  81          bit   WakeUp_Flag = 0;
  82          
  83          //Íâ²¿±äÁ¿½Ó¿Ú
  84          extern  unsigned  char  data    CurrentChannelMax;    //µ±Ç°Ñ¡ÖÐµÄkeysensorµÄ¸öÊý
  85          extern  bit  bMultiple; //¶à°´¼ü±êÖ¾
  86          extern  unsigned  int     xdata       ScanTime;
  87            
  88          extern  bit  GetIsNeedUpdateBaseline(void);
  89          extern  void SetNeedUpdateBaseline(void);
  90          extern  unsigned long int SensorKeyFlag(void);
  91          extern  void MultipleDeal(unsigned char CycleCnt);
  92          extern  void FilterDataDeal(unsigned char i);
  93          extern  void TouchKey_Service(void);
  94          void  TKSleepMode(void);
  95          /***************µ¯»É¿â¶ÀÓÐ***************/
  96          #define   SOCAPI_SET_CS_FUNCTION            1   //0:±íÊ¾²»½øÐÐCS²âÊÔ,1: ±íÊ¾½øÐÐCS²âÊÔ,Ä¬ÈÏ0
  97          #define   SOCAPI_INHIBITION_ZONE              8   //ÒÖÖÆÇø¼ä%£¬ÉèÖÃ·¶Î§5-10£¬Ä¬ÈÏ7,¼´£¨7*10£©%=70% £¬Á¬Ë®Ê±¼Ó´ó¸Ã
             -²ÎÊý,¶Ô½²»úÉèÖÃÐ¡
  98          #define   SOCAPI_MAX_KEY_MUTIPLE            300   //¶àÉÙ´Î¸ÉÈÅ¸üÐÂ»ùÏß£¬Ä¬ÈÏ300*5=1500
  99          #define   SOCAPI_MAX_KEY_NUM_INVALID          3   //Ç¿ÖÆ¸üÐÂ»ùÏß°´¼üÏÞÖÆ¸öÊý£¬Ä¬ÈÏ3
 100          /****************************************/
 101          
 102          #define     AppType               0
 103          #define     IsDoubleKey           1
 104          #define     AirSeparationDistance       2
 105          #define     CONFIRMTOUCHCNT                 3
 106          #define     INIT_AUTO_UPDATE_TIME       4
 107          #define     SET_KEY_CONTI_TIME              5  
 108          #define     SET_SYNC_UPDATE         6
 109          #define     SET_UPDATE_SPEED        7 
 110          #define     AUTO_UPDATE_TIME            8
 111          #define     FilteredKValue          9
 112          #define     SET_ANTIJAM             10
 113          #define     BAUD                    11
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 3   

 114          #define     DwellTime               12
 115          #define     SaveTime              13
 116          #define     NOISE                           16
 117          
 118          #define     SET_TOUCH_FREQ          0
 119          #define     SET_RESOLUTION          1
 120          #define     SET_GAIN_CFG          2
 121          #define     SCANTIME            3
 122          #define     SET_ICHA            4
 123          #define     FINGER_THRESHOLD_H          6
 124          #define     FINGER_THRESHOLD_L          7
 125          
 126          //**********************************************************************************  
 127          //                µÍ¹¦ºÄÉèÖÃ                //
 128          //**********************************************************************************
 129          #define     TK_LowPowerMode                
 130          
 131          #ifdef  TK_LowPowerMode
 132          
 133          #define ScanTimeCon   3
 134          
 135          #define   BTM_TIMEBASE_15600US     0X00   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª15.6MS
 136          #define   BTM_TIMEBASE_31300US     0X01   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª31.3MS
 137          #define   BTM_TIMEBASE_62500US     0X02   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª62.5MS
 138          #define   BTM_TIMEBASE_125MS     0X03   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª125MS
 139          #define   BTM_TIMEBASE_250MS       0X04   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª250MS
 140          #define   BTM_TIMEBASE_500MS       0X05   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª500MS
 141          #define   BTM_TIMEBASE_1S          0X06   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª1S
 142          #define   BTM_TIMEBASE_2S          0X07   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª2S
 143          #define   BTM_TIMEBASE_4S          0X08   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª4S
 144          
 145          #include <intrins.h>
 146          
 147          #define      WakeUpKeyNum             SOCAPI_SET_TOUCHKEY_TOTAL     //µÍ¹¦ºÄÄ£Ê½ÏÂÉ¨Ãè°´¼ü¸öÊý     
 148          #define      WakeUpKeyChannel         SOCAPI_SET_TOUCHKEY_CHANNEL   //µÍ¹¦ºÄÏÂÉ¨Ãè°´¼üµÄ¶ÔÓ¦Í¨µÀ
 149          #define      TK_SeepTimervSetting              BTM_TIMEBASE_125MS   //µÍ¹¦ºÄÏÂ°´¼üÖ®¼äµÄÉ¨Ãè¼ä¸ô
 150          #define      TK_WakeUpConfirmTouchCnt          10           //µÍ¹¦ºÄÏÂÈ·ÈÏ°´¼ü´ÎÊý
 151          
 152          #if TK_SeepTimervSetting == BTM_TIMEBASE_4S             //µÍ¹¦ºÄÏÂ»ùÏß¸üÐÂ¼ä¸ô¶¨Òå
                #define  BaselineUpdateCnt  1                   
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_2S             
                #define  BaselineUpdateCnt  3
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_1S             
                #define  BaselineUpdateCnt  6
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_500MS          
                #define  BaselineUpdateCnt  12
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_250MS           
                #define  BaselineUpdateCnt  24
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_125MS
 163            #define  BaselineUpdateCnt  48
 164          #elif TK_SeepTimervSetting == BTM_TIMEBASE_62500US
                #define  BaselineUpdateCnt  96
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_31300US
                #define  BaselineUpdateCnt  192
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_15600US
                #define  BaselineUpdateCnt  384                 
              #endif
 171          
 172          bit  LowPowerScan_Flag = 0;                                         //µÍ¹¦ºÄÉ¨Ãè±êÖ¾
 173          bit  SingleKeyFastScan_Flag = 0;                                    //µ¥°´¼ü¿ìËÙÉ¨Ãè±êÖ¾
 174          bit  BTM_WakeUpFlag =0;                       //BTM»½ÐÑ±êÖ¾Î»
 175          bit  Touch_WakeUpFlag=0;                      //°´¼ü»½ÐÑ±êÖ¾Î»
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 4   

 176          
 177          unsigned    char    idata       WakeUpKey_List[WakeUpKeyNum];
 178          unsigned  char  idata       WakeUpThenScanCount = 0; 
 179          unsigned  int   WakeUpNum;                    //»½ÐÑ´ÎÊý¼ÆÊý--ÓÃÓÚµÍ¹¦ºÄÏÂ¸üÐÂ»ùÏß
 180          unsigned  char  WakeUpKeyValue;                 //==WakeUpKey_List[WakeUpKey_Index]
 181          //unsigned  char  LastWakeUpKeyValue;             //ÉÏ´Î»½ÐÑµÄ¼üÖµ
 182          unsigned  int   ScanTimeTemp0;                  //==ScanTime>>4
 183          
 184          
 185           void Customer_IntoLowPowerMode_Init(void);
 186           void Customer_QuitLowPowerMode_Init(void);
 187           void Customer_BTM_Dispose(void);
 188          
 189          //**********************************************************************************
 190          /**************************************************
 191          *º¯ÊýÃû³Æ£ºvoid Customer_IntoLowPowerMode_Init(void)
 192          *º¯Êý¹¦ÄÜ£ºÓÃ»§½øÈëµÍ¹¦ºÄÄ£Ê½Ç°µÄµÄ³õÊ¼»¯
 193          *Èë¿Ú²ÎÊý£ºvoid
 194          *³ö¿Ú²ÎÊý£ºvoid  
 195          *±¸×¢ËµÃ÷£ºÔÚ½øÈëµÍ¹¦ºÄÇ°£¬ÓÃ»§ÐèÒª¹Ø±ÕÍâÎ§ºÄµçµÄµçÂ·£¬Ê¹µçÁ÷×îµÍ
 196          *        ¸Ãº¯ÊýÒÑÔÚS_TouchKeyCFG.CÎÄ¼þTouchKey_IntoLowPowerMode()º¯ÊýÖÐµ÷ÓÃ,ÓÃ»§ÎÞÐèµ÷ÓÃ
 197          **************************************************/
 198          void Customer_IntoLowPowerMode_Init(void)
 199          {
 200   1          /*½øÈëµÍ¹¦ºÄÇ°ÉèÖÃ*/
 201   1        //¸Ãº¯ÊýÒÑÔÚTouchKey_IntoLowPowerMode()Àïµ÷ÓÃ
 202   1        
 203   1        //ÓÃ»§ÎÞÐèµ÷ÓÃ¸Ãº¯Êý£¡£¡£¡
 204   1        
 205   1        //ÓÃ»§ÐèÒª×Ô¼º±àÐ´¸Ãº¯ÊýÊµÌå£¡£¡£¡
 206   1      
 207   1        //¹Ø±ÕºÄµçµÄÍâÉè£¬±£³Ö×îµÍ¹¦ºÄ
 208   1      
 209   1      }
 210          /**************************************************
 211          *º¯ÊýÃû³Æ£ºvoid Customer_QuitLowPowerMode_Init(void)
 212          *º¯Êý¹¦ÄÜ£ºÓÃ»§ÍË³öµÍ¹¦ºÄÄ£Ê½ºóµÄµÄ³õÊ¼»¯
 213          *Èë¿Ú²ÎÊý£ºvoid
 214          *³ö¿Ú²ÎÊý£ºvoid
 215          *±¸×¢ËµÃ÷£ºÔÚÍË³öµÍ¹¦ºÄÇ°£¬ÓÃ»§½øÐÐµÄ±ØÒª²Ù×÷
 216          *      ¸Ãº¯ÊýÒÑÔÚS_TouchKeyCFG.cÎÄ¼þTouchKey_QuitLowPowerMode()º¯ÊýÖÐµ÷ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
 217          **************************************************/
 218          void Customer_QuitLowPowerMode_Init(void)
 219          {
 220   1         /*ÍË³öµÍ¹¦ºÄÇ°ÉèÖÃ*/
 221   1         
 222   1         //¸Ãº¯ÊýÒÑÔÚµÍ¹¦ºÄÏÂÂú×ãTK»½ÐÑÍË³öµÍ¹¦ºÄÊ±µ÷ÓÃ£¬¼´ÔÚTouchKey_QuitLowPowerMode()ÖÐµ÷ÓÃ
 223   1      
 224   1         //ÓÃ»§ÎÞÐèµ÷ÓÃ¸Ãº¯Êý£¡£¡£¡
 225   1       
 226   1         //ÓÃ»§ÐèÒª×Ô¼º±àÐ´¸Ãº¯ÊýÊµÌå£¡£¡£¡
 227   1      
 228   1         //»Ö¸´±ØÒªµÄÍâÉè
 229   1      }
 230          /**************************************************
 231          *º¯ÊýÃû³Æ£ºvoid Customer_BTM_Dispose(void)
 232          *º¯Êý¹¦ÄÜ£ºÓÃ»§BTM»½ÐÑºó×Ô¼ºµÄ´¦Àíº¯Êý
 233          *Èë¿Ú²ÎÊý£ºvoid
 234          *³ö¿Ú²ÎÊý£ºvoid  
 235          *±¸×¢ËµÃ÷£ºµÍ¹¦ºÄÊµÏÖÀûÓÃÁËBTM×ÊÔ´£¬ÓÃ»§ÐèÒªÔÚBTMÖÐÊµÏÖµÄÄÚÈÝÔÚ´Ëº¯ÊýÊµÏÖ
 236                 ¸Ãº¯ÊýÒÑÔÚS_TouchKeyCFG.cÎÄ¼þLowPower_Touchkey_Scan()º¯ÊýÖÐµ÷ÓÃ
 237          **************************************************/
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 5   

 238          void Customer_BTM_Dispose(void)
 239          {
 240   1         //¸Ãº¯ÊýÒÑÔÚµÍ¹¦ºÄÄ£Ê½É¨Ãèº¯ÊýÖÐµ÷ÓÃ
 241   1      
 242   1         //´Ëº¯ÊýÎªBTM¶¨Ê±»½ÐÑºó£¬ÓÃ»§µÄ´¦Àíº¯Êý
 243   1      
 244   1         //µÍ¹¦ºÄÄ£Ê½ÏÂ£¬ÓÃ»§ÐèÔÚBTMÖÐÊµÏÖµÄ¹¦ÄÜ¿ÉÔÚ´Ëº¯ÊýÊµÏÖ   
 245   1      
 246   1         //±ÈÈç²éÑ¯Ä³¸öIO£¬µçÆ½·¢Éú±ä»¯µÈÌõ¼þ³ÉÁ¢£¬(TK»½ÐÑ³ýÍâ)ÐèÍË³öµÍ¹¦ºÄÄ£Ê½¿ÉÔÚ´Ëº¯ÊýÖÐµ÷ÓÃTouchKey_QuitLowP
             -owerMode()
 247   1      
 248   1         /*
 249   1         if(TEST_IO == 0)
 250   1         {
 251   1         //do someing
 252   1         TouchKey_QuitLowPowerMode();
 253   1         }
 254   1         */
 255   1      
 256   1      }
 257          /**************************************************
 258          *º¯ÊýÃû³Æ£ºvoid BtmInit(void) 
 259          *º¯Êý¹¦ÄÜ£º
 260          *Èë¿Ú²ÎÊý£ºvoid 
 261          *³ö¿Ú²ÎÊý£ºvoid
 262          **************************************************/
 263          void BTM_Init(void)
 264          {
 265   1          BTMCON = BTMCON & 0XF0 | TK_SeepTimervSetting;
 266   1          BTMCON |= 0X80;
 267   1        TK_IE1 |= 0X04;
 268   1      }
 269          /**************************************************
 270          *º¯ÊýÃû³Æ£ºvoid BtmInit(void) interrupt 0
 271          *º¯Êý¹¦ÄÜ£ºBtmÖÐ¶Ï·þÎñº¯Êý
 272          *Èë¿Ú²ÎÊý£ºvoid 
 273          *³ö¿Ú²ÎÊý£ºvoid
 274          **************************************************/
 275          void BtmInit(void) interrupt  9
 276          {
 277   1         BTM_WakeUpFlag = 1;
 278   1        LowPowerTimer_ISR();
 279   1      }
 280          #endif
 281          
 282          //**********************************************************************************  
 283          //                º¯Êý½Ó¿Úµ÷ÓÃ²¿·Ö                  //
 284          //**********************************************************************************
 285          /**************************************************
 286          *º¯ÊýÃû³Æ£ºunsigned int SetOneKeyPushResetTime(void) 
 287          *º¯Êý¹¦ÄÜ£º°´¼ü×î³¤µÄÊä³öÊ±¼ä
 288          *Èë¿Ú²ÎÊý£ºvoid
 289          *³ö¿Ú²ÎÊý£ºunsigned int SOCAPI_SET_KEY_CONTI_TIME
 290          *±¸×¢  £ºÕâ¸ö·µ»ØÖµµÄÉèÖÃ£¬ ÊÇ¸ù¾ÝÓÐ¶à³¤Ê±¼äÆô¶¯TouchKeyRestart£¨£©Ò»´Î
 291          ÀýÈç10ms Æô¶¯Ò»´Î£¬ ÄÇSOCAPI_SET_KEY_CONTI_TIME*10ms£¬³¬¹ýÊ±¼äºó´Ë°´¼üÎÞÐ§¡£
 292          **************************************************/
 293          unsigned int SetOneKeyPushResetTime(void)   
 294          {   
 295   1        return  TKCFG[SET_KEY_CONTI_TIME];
 296   1      }
 297          /**************************************************
 298          *º¯ÊýÃû³Æ£ºint  GetBaselineUpdateThreshold(void)
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 6   

 299          *º¯Êý¹¦ÄÜ£º¸üÐÂËÙ¶È 
 300          *Èë¿Ú²ÎÊý£ºvoid
 301          *³ö¿Ú²ÎÊý£º  int 
 302          *±¸×¢  £º
 303          **************************************************/
 304          int  GetBaselineUpdateThreshold(void)
 305          {
 306   1        return TKCFG[SET_UPDATE_SPEED]; 
 307   1      }
 308          
 309          /**************************************************
 310          *º¯ÊýÃû³Æ£ºunsigned char GetInitAutoUpdateTime(void)
 311          *º¯Êý¹¦ÄÜ£º³õÊ¼»¯×Ô¶¯Ð£×¼´ÎÊý
 312          *Èë¿Ú²ÎÊý£ºvoid
 313          *³ö¿Ú²ÎÊý£ºunsigned  char 
 314          *±¸×¢  £º
 315          **************************************************/
 316          unsigned char GetInitAutoUpdateTime(void)
 317          {
 318   1        return  TKCFG[INIT_AUTO_UPDATE_TIME];
 319   1      }
 320          /**************************************************
 321          *º¯ÊýÃû³Æ£ºunsigned char GetCsFunction(void)
 322          *º¯Êý¹¦ÄÜ£º½øÐÐCS ²âÊÔ
 323          *Èë¿Ú²ÎÊý£ºvoid
 324          *³ö¿Ú²ÎÊý£ºchar SOCAPI_SET_CS_FUNCTION
 325          *±¸×¢  £º
 326          **************************************************/
 327          unsigned char GetCsFunction(void)
 328          {
 329   1        return SOCAPI_SET_CS_FUNCTION; 
 330   1      }
 331          /**************************************************
 332          *º¯ÊýÃû³Æ£ºint  GetCurrFingerValue(unsigned char i)
 333          *º¯Êý¹¦ÄÜ£º»ñÈ¡µ±Ç°µÄfinger Öµ
 334          *Èë¿Ú²ÎÊý£ºunsigned char
 335          *³ö¿Ú²ÎÊý£ºint 
 336          *±¸×¢  £º
 337          **************************************************/
 338          unsigned int   GetCurrFingerValue(unsigned char i)
 339          { 
 340   1        return  TKChannelCfg[i][FINGER_THRESHOLD_H]*256+TKChannelCfg[i][FINGER_THRESHOLD_L] ;
 341   1      }
 342          
 343          /**************************************************
 344          *º¯ÊýÃû³Æ£ºunsigned char  GetScanTimeValue(unsigned char i)
 345          *º¯Êý¹¦ÄÜ£º»ñÈ¡µ±Ç°Í¨µÀµÄÉ¨ÃèÊ±¼ä
 346          *Èë¿Ú²ÎÊý£ºunsigned char
 347          *³ö¿Ú²ÎÊý£ºunsigned char 
 348          *±¸×¢  £º
 349          **************************************************/
 350          unsigned char  GetScanTimeValue(unsigned char i)
 351          { 
 352   1        return TKChannelCfg[i][SCANTIME];
 353   1      }
 354          /**************************************************
 355          *º¯ÊýÃû³Æ£ºunsigned char IsDoubleKeyOrSlideKey(void)
 356          *º¯Êý¹¦ÄÜ£º¼ì²âÊÇ·ñÊÇµ¯»É»¬Ìõ»òÕßË«¼ü
 357          *Èë¿Ú²ÎÊý£ºvoid
 358          *³ö¿Ú²ÎÊý£ºunsigned char 
 359          *±¸×¢  £º
 360          **************************************************/
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 7   

 361          unsigned char IsDoubleKeyOrSlideKey(void)
 362          {
 363   1          return TKCFG[IsDoubleKey];
 364   1      }
 365          /**************************************************
 366          *º¯ÊýÃû³Æ£ºunsigned char  GetBaseLineAdjustValue(unsigned char i)
 367          *º¯Êý¹¦ÄÜ£º»ñÈ¡µ±Ç°Í¨µÀµÄ»ùÏßµ÷Õû
 368          j
 369          *Èë¿Ú²ÎÊý£ºunsigned char
 370          *³ö¿Ú²ÎÊý£ºunsigned char 
 371          *±¸×¢  £º
 372          **************************************************/
 373          unsigned char  GetBaseLineAdjustValue(unsigned char i)
 374          { 
 375   1           return BaseLineAdjusttmp[i]; 
 376   1      }
 377          /**************************************************
 378          *º¯ÊýÃû³Æ£ºunsigned char GetUpConfirmCnt(void)
 379          *º¯Êý¹¦ÄÜ£º¼ì²â°´¼üµ¯Æð´ÎÊý
 380          *Èë¿Ú²ÎÊý£ºvoid
 381          *³ö¿Ú²ÎÊý£º·µ»Ø°´¼üµ¯ÆðÈ·ÈÏ´ÎÊý 
 382          *±¸×¢  £º
 383          **************************************************/
 384          unsigned char GetUpConfirmCnt(void)
 385          {
 386   1        return ConfirmTouchCnt>>1;
 387   1      }
 388          /**************************************************
 389          *º¯ÊýÃû³Æ£ºunsigned char GetTKYzCnt(void)
 390          *º¯Êý¹¦ÄÜ£º»ñÈ¡°´¼üÒÖÖÆÈ·ÈÏ´ÎÊý
 391          *Èë¿Ú²ÎÊý£ºvoid
 392          *³ö¿Ú²ÎÊý£º·µ»ØÒÖÖÆ´ÎÊý 
 393          *±¸×¢  £º
 394          **************************************************/
 395          
 396          unsigned char GetTKYzCnt(void)
 397          {
 398   1        return (ConfirmTouchCnt/3);
 399   1      }
 400          
 401          /**************************************************
 402          *º¯ÊýÃû³Æ£ºint GetTKYzThreshold(unsigned char i)
 403          *º¯Êý¹¦ÄÜ£º»ñÈ¡°´¼üÒÖÖÆÇø¼ä
 404          *Èë¿Ú²ÎÊý£ºunsigned char i
 405          *³ö¿Ú²ÎÊý£º·µ»ØÒÖÖÆÇø¼ä
 406          *±¸×¢  £º
 407          **************************************************/
 408          unsigned int GetTKYzThreshold(unsigned char i)
 409          { 
 410   1        unsigned int SetFingerThresholdtmp; 
 411   1        
 412   1        SetFingerThresholdtmp = GetCurrFingerValue(i); 
 413   1          SetFingerThresholdtmp = SetFingerThresholdtmp*SOCAPI_INHIBITION_ZONE/10;
 414   1      
 415   1        return SetFingerThresholdtmp;
 416   1      }
 417          /**************************************************
 418          *º¯ÊýÃû³Æ£ºvoid CurrentSensorChoose(void)
 419          *º¯Êý¹¦ÄÜ£ºµ±Ç°Í¨µÀÑ¡Ôñ
 420          *Èë¿Ú²ÎÊý£ºvoid
 421          *³ö¿Ú²ÎÊý£ºvoid
 422          *±¸×¢  £º
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 8   

 423          **************************************************/
 424          void CurrentSensorChoose(void)
 425          {
 426   1        unsigned char   i = 0;
 427   1        unsigned char   Ctk_Channel_mark = 0;
 428   1        unsigned char   WakeUpKey_Channel_mark = 0;
 429   1        unsigned long int CurrentSensorKey = 0 ; 
 430   1        
 431   1        CurrentSensorKey = SOCAPI_SET_TOUCHKEY_CHANNEL; 
 432   1          
 433   1        for(i=0;i<31;i++)
 434   1        {
 435   2          CurrentSensorKey=CurrentSensorKey>>1;
 436   2          if(TK_CY)
 437   2          {
 438   3            CurrentChannel[Ctk_Channel_mark] = i;           //Ñ¡Ôñ´¥Ãþµ±Ç°µÄÍ¨µÀ
 439   3                  #ifdef  TK_LowPowerMode
 440   3            if(WakeUpKey_Channel_mark<WakeUpKeyNum)
 441   3                  {
 442   4                      if((WakeUpKeyChannel&((unsigned long int)1<<i)))
 443   4                      {
 444   5                          WakeUpKey_List[WakeUpKey_Channel_mark++] = Ctk_Channel_mark;
 445   5                      }
 446   4                  }
 447   3                  #endif
 448   3            Ctk_Channel_mark++;
 449   3            if(Ctk_Channel_mark >= SOCAPI_SET_TOUCHKEY_TOTAL)
 450   3              break;
 451   3          }   
 452   2        }
 453   1        CurrentChannelMax = Ctk_Channel_mark;             //µ±Ç°Ñ¡ÔñµÄ°´¼üÊý 
 454   1      }
 455          
 456          /**************************************************
 457          *º¯ÊýÃû³Æ£ºunsigned char  GetCfgMsg(unsigned char i)
 458          *º¯Êý¹¦ÄÜ£º»ñÈ¡Touch KEY ÅäÖÃÐÅÏ¢
 459          *Èë¿Ú²ÎÊý£ºvoid
 460          *³ö¿Ú²ÎÊý£ºint 
 461          *±¸×¢  £º
 462          **************************************************/
 463          unsigned char  GetCfgMsg(unsigned char i)
 464          {
 465   1        switch(i)
 466   1        { 
 467   2           case 0:  return TKChannelCfg[0][SET_TOUCH_FREQ];
 468   2           case 1:  return TKChannelCfg[0][SET_RESOLUTION];
 469   2           case 2:  return TKChannelCfg[0][SET_GAIN_CFG];
 470   2           case 3:  return GetBaseLineAdjustValue(0); //TKChannelCfg[0][SET_GAIN_CFG];
 471   2           case 4:  return TKCFG[SET_ANTIJAM];
 472   2           default:return 0;    
 473   2        }
 474   1      }
 475          
 476          /**************************************************
 477          *º¯ÊýÃû³Æ£ºvoid TouchKeyCFGInit(void)
 478          *º¯Êý¹¦ÄÜ£º³õÊ¼»¯TK¼Ä´æÆ÷
 479          *Èë¿Ú²ÎÊý£ºvoid
 480          *³ö¿Ú²ÎÊý£ºvoid
 481          *±¸×¢  £º
 482          **************************************************/
 483          void TouchKeyCFGInit(void)
 484          {
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 9   

 485   1        unsigned char   i;
 486   1        ConfirmTouchCnt = TKCFG[CONFIRMTOUCHCNT];
 487   1        SetNoiseThreshold = TKCFG[NOISE];
 488   1        CurrentSensorChoose(); 
 489   1         for(i=0;i<CurrentChannelMax;i++)
 490   1        {
 491   2          BaseLineAdjusttmp[i] =TKChannelCfg[i][SET_ICHA];; 
 492   2        } 
 493   1        UpdateBaseLNum = 0;
 494   1          #ifdef  TK_LowPowerMode
 495   1          BTM_Init();
 496   1          #endif 
 497   1      }
 498          
 499          /**************************************************
 500          *º¯ÊýÃû³Æ£ºunsigned int TouchKeyScan(void)
 501          *º¯Êý¹¦ÄÜ£º¼ì²â°´¼ü½Ó¿Ú
 502          *Èë¿Ú²ÎÊý£ºvoid
 503          *³ö¿Ú²ÎÊý£º°´¼üÍ¨µÀ£¬ ·µ»ØµÄÊÇÒ»¸öint , Í¨µÀÊý
 504          *±¸×¢  £º1,  µ÷ÓÃ´¥¿Ø¿â¼ì²âº¯ÊýSensorKeyFlag()
 505                 2,  ·ÖÎöµÃ³ö16¸öÍ¨µÀ£¬ÄÄ¸öÍ¨µÀÓÐ°´ÏÂ£¬°´ÏÂbit Î»ÉèÖÃÎª1£¬·ñÔòÎª0
 506                 3,  ¼ì²âÊÇ·ñÐèÒªÁ¢¼´¸üÐÂbaseline:  ´óÓÚMAX_KEY_RESET_BASELINE ¸ö°´¼ü°´ÏÂÊ±Á¢¼´¸üÐÂbaseline
 507                 4,  Ë«¼ü»òÕßµ¥¼ü°´ÏÂÊ±£¬ Ê±¼ä´óÓÚSetOneKeyPushResetTime()½á¹ûÊ±¸üÐÂbaseline 
 508          **************************************************/
 509          unsigned char OffHandCount = 0;
 510          unsigned int  NumCount = 0;
 511          unsigned long int TouchKeyScan(void)
 512          {
 513   1        unsigned char t;
 514   1          unsigned char MultipleCnt = 0;//°´¼ü¼ÆÊý
 515   1        unsigned long int Keyvalue = 0; 
 516   1        unsigned long int KeyData = 0;  
 517   1        int WakeupDiffData = 0; 
 518   1        int WakeupSetFingerThresholdtmp;
 519   1        
 520   1        
 521   1        if(WakeUp_Flag == 0)
 522   1        {
 523   2          if(GetIsNeedUpdateBaseline() == 0)        //¼ì²âÊÇ·ñÐèÒª¸üÐÂbaseline 
 524   2          {
 525   3            Keyvalue = SensorKeyFlag();         //SensorÅÐ¶Ï, ÕâÀïÈç¹ûbMultiple = 1 ±íÊ¾ÖÐ¼äÓÐ¸ÉÈÅ   //·ÖÎö°´¼ü£¬µÃ³ö±ê×
             -¼µÄ16Í¨µÀbit Î»                                      
 526   3            for(t=0;t<CurrentChannelMax;t++)
 527   3            {
 528   4              Keyvalue = Keyvalue>>1;
 529   4              if(TK_CY)
 530   4              {
 531   5                KeyData |= ((unsigned long int)0x01 << (CurrentChannel[t]));              
 532   5                MultipleCnt++;              
 533   5              }
 534   4            }                
 535   3            if(MultipleCnt >= 2)              //½øÈë¶à°´¼ü´¦Àí
 536   3            {     
 537   4              bMultiple = 1;      
 538   4              if(MultipleCnt >= SOCAPI_MAX_KEY_NUM_INVALID)
 539   4              {
 540   5                SetNeedUpdateBaseline();        // Á¢¼´¸üÐÂbaseline ,ÀýÈçÑÇ¿ËÁ¦°å¸ÇÉÏÈ¥
 541   5              }
 542   4              else
 543   4              {         
 544   5                if(IsDoubleKeyOrSlideKey())
 545   5                {
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 10  

 546   6                  bMultiple = 0;
 547   6                }          
 548   5              }     
 549   4            }     
 550   3        
 551   3            if(bMultiple == 0)                //½øÈë°´¼üÅÐ¶Ï
 552   3            {   
 553   4              if(KeyData != 0x0)                //µ¥¸ö°´¼ü´ïµ½¶à³¤Ê±¼ä¾Íupdate baseline ,ËÉÊÖ¼ì²â
 554   4              {     
 555   5                UpdateBaseLNum++; 
 556   5              }
 557   4              else  
 558   4              {
 559   5                UpdateBaseLNum = 0;   
 560   5              } 
 561   4            } 
 562   3            else
 563   3            {   
 564   4                //¿¼ÂÇ»ùÏß¸üÐÂ    
 565   4              MultipleLNum++; 
 566   4              KeyData = 0x00;
 567   4            }
 568   3        
 569   3            if(UpdateBaseLNum > SetOneKeyPushResetTime()) //°´¼ü³¬³ö×î³¤Êä³öÊ±¼ä¸üÐÂ»ùÏß
 570   3            {
 571   4              SetNeedUpdateBaseline(); 
 572   4              UpdateBaseLNum = 0;
 573   4            }
 574   3                
 575   3            if(MultipleLNum >SOCAPI_MAX_KEY_MUTIPLE)    //¸ÉÈÅ¼ÆÊý´óÓÚ×î´ó¼ÆÊý¸üÐÂ»ùÏß
 576   3            {
 577   4              SetNeedUpdateBaseline(); 
 578   4              MultipleDealTpye = 1; 
 579   4              MultipleLNum = 0;
 580   4            }  
 581   3          }     
 582   2          else
 583   2          {
 584   3            MultipleDeal(TKCFG[AUTO_UPDATE_TIME]);      //»ùÏß¸´Î»´¦Àí
 585   3          }
 586   2        }
 587   1        else
 588   1        {
 589   2              #ifdef  TK_LowPowerMode
 590   2          
 591   2          if(Touch_WakeUpFlag==1)
 592   2          {
 593   3            KeyData |= ((unsigned long int)0x01 << (CurrentChannel[WakeUpKeyValue]));
 594   3      
 595   3            WakeupDiffData = RawData[WakeUpKeyValue]-BaseLine[WakeUpKeyValue];
 596   3            WakeupSetFingerThresholdtmp = GetCurrFingerValue(WakeUpKeyValue);
 597   3      
 598   3            if(WakeupDiffData <= (WakeupSetFingerThresholdtmp-((WakeupSetFingerThresholdtmp)>>2)))
 599   3            { 
 600   4              NumCount=0;
 601   4              if(++OffHandCount>5)
 602   4              {
 603   5                OffHandCount = 0;
 604   5                WakeUp_Flag = 0;
 605   5                Touch_WakeUpFlag=0;
 606   5                KeyData = 0;
 607   5              }
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 11  

 608   4              for(t=0;t<CurrentChannelMax;t++)
 609   4              {
 610   5                FilterDataDeal(t);
 611   5                if(!WakeUp_Flag)
 612   5                {
 613   6                  if(WakeUpKeyValue == t)
 614   6                  continue;
 615   6                  BaseLine[t] = RawData[t]; 
 616   6                }
 617   5              }
 618   4                
 619   4            }
 620   3            else
 621   3            {
 622   4              OffHandCount=0;
 623   4              if(++NumCount > SetOneKeyPushResetTime()) //°´¼ü³¬³ö×î³¤Êä³öÊ±¼ä¸üÐÂ»ùÏß
 624   4              {
 625   5                SetNeedUpdateBaseline(); 
 626   5                NumCount = 0;
 627   5                WakeUp_Flag = 0;
 628   5                Touch_WakeUpFlag=0;
 629   5                KeyData = 0;
 630   5              }   
 631   4            }
 632   3          }
 633   2          else
 634   2          {
 635   3            if(++WakeUpThenScanCount>5)
 636   3            {
 637   4              WakeUpThenScanCount = 0;
 638   4              WakeUp_Flag = 0;
 639   4            }
 640   3            for(t=0;t<CurrentChannelMax;t++)
 641   3            {
 642   4              FilterDataDeal(t);
 643   4              if(!WakeUp_Flag)
 644   4              {
 645   5                BaseLine[t] = RawData[t]; 
 646   5              } 
 647   4            }
 648   3          }
 649   2          
 650   2          #endif
 651   2        }  
 652   1        return KeyData;
 653   1      }
 654          
 655          /**************************************************
 656          *º¯ÊýÃû³Æ£ºvoid CTK_ISR(void) interrupt 11
 657          *º¯Êý¹¦ÄÜ£º´¥ÃþÖÐ¶Ï·þÎñº¯Êý
 658          *Èë¿Ú²ÎÊý£ºvoid
 659          *³ö¿Ú²ÎÊý£ºvoid
 660          *±¸×¢  £º
 661          **************************************************/
 662          void CTK_ISR(void) interrupt  11
 663          {
 664   1         TouchKey_Service();
 665   1      }
 666          
 667          /**************************************************
 668          *º¯ÊýÃû³Æ£ºbit GetLowPowerScanFlag(void)
 669          *º¯Êý¹¦ÄÜ£d»ñÈ¡µÍ¹¦ºÄÄ£Ê½
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 12  

 670          *Èë¿Ú²ÎÊý£ºvoid
 671          *³ö¿Ú²ÎÊý£ºvoid  
 672          **************************************************/
 673          bit GetLowPowerScanFlag(void)
 674          {
 675   1          #ifdef  TK_LowPowerMode
 676   1          return LowPowerScan_Flag;
 677   1          #endif
 678   1      }
 679          
 680          /**************************************************
 681          *º¯ÊýÃû³Æ£ºvoid TouchKey_LowPower_Init(unsigned char i)
 682          *º¯Êý¹¦ÄÜ£dµÍ¹¦ºÄ³õÊ¼»¯
 683          *Èë¿Ú²ÎÊý£ºvoid
 684          *³ö¿Ú²ÎÊý£ºvoid  
 685          **************************************************/
 686          unsigned  char    xdata       BaseLineAdjusttmp_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 687          unsigned  char  xdata       CurrentChannel_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 688          unsigned  int   xdata       ScanTimeTemp_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 689          int   data       SetFingerThresholdtmp_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 690          void TouchKey_LowPower_Init(void)
 691          {
 692   1          unsigned char i;
 693   1            
 694   1          for(i=0;i<WakeUpKeyNum;i++)
 695   1          {
 696   2            WakeUpKeyValue = WakeUpKey_List[i];
 697   2            ScanTimeTemp_Low[WakeUpKeyValue] = ScanTimeTemp0*TKChannelCfg[WakeUpKeyValue][SCANTIME];
 698   2            BaseLineAdjusttmp_Low[WakeUpKeyValue] = BaseLineAdjusttmp[WakeUpKeyValue];//(TKCFG1 & 0X80) | BaseLineA
             -djusttmp[WakeUpKeyValue];
 699   2            CurrentChannel_Low[WakeUpKeyValue] =  0xc0|CurrentChannel[WakeUpKeyValue];
 700   2      
 701   2            SetFingerThresholdtmp_Low[WakeUpKeyValue] = TKChannelCfg[WakeUpKeyValue][FINGER_THRESHOLD_H]*256+TKChan
             -nelCfg[WakeUpKeyValue][FINGER_THRESHOLD_L];        
 702   2      
 703   2            TKCFG0 &= 0XF0;
 704   2            TKCFG0 |= TKChannelCfg[0][SET_TOUCH_FREQ];
 705   2          }
 706   1      }
 707          
 708          /**************************************************
 709          *º¯ÊýÃû³Æ£ºvoid TouchKey_IntoLowPowerMode(void)
 710          *º¯Êý¹¦ÄÜ£d½øÈëµÍ¹¦ºÄÄ£Ê½
 711          *Èë¿Ú²ÎÊý£ºvoid
 712          *³ö¿Ú²ÎÊý£ºvoid  
 713          **************************************************/
 714          void TouchKey_IntoLowPowerMode(void)
 715          {
 716   1          #ifdef  TK_LowPowerMode
 717   1        unsigned char t;
 718   1          LowPowerScan_Flag = 1;
 719   1      
 720   1        ScanTimeTemp0 = ScanTime >> ScanTimeCon;
 721   1          Customer_IntoLowPowerMode_Init();
 722   1      
 723   1          TouchKey_LowPower_Init();
 724   1         
 725   1        for(t=0;t<CurrentChannelMax;t++)
 726   1        {
 727   2           TouchCnt[t] = 0;
 728   2        }
 729   1          #endif
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 13  

 730   1      }
 731          
 732          #ifdef  TK_LowPowerMode
 733          /**************************************************
 734          *º¯ÊýÃû³Æ£ºvoid TouchKey_QuitLowPowerMode(void)
 735          *º¯Êý¹¦ÄÜ£dÍË³öµÍ¹¦ºÄÄ£Ê½
 736          *Èë¿Ú²ÎÊý£ºvoid
 737          *³ö¿Ú²ÎÊý£ºvoid  
 738          **************************************************/
 739          void TouchKey_QuitLowPowerMode(void)
 740          {
 741   1         LowPowerScan_Flag = 0;
 742   1           WakeUp_Flag = 1;
 743   1         
 744   1           TKCR = 0x80|CurrentChannel[0];
 745   1         TKTM = ScanTime*TKChannelCfg[0][SCANTIME]>>3; 
 746   1           TK_IE1 = TK_IE1&(~0x10);       //¹Ø±ÕTKÖÐ¶Ï
 747   1         TRIG = 1;
 748   1         while(TRIF == 0);  
 749   1         TRIF = 0;
 750   1         TK_IE1 = TK_IE1|0x10;            //Ê¹ÄÜTKÖÐ¶Ï
 751   1           TRIG = 1; 
 752   1           Customer_QuitLowPowerMode_Init();
 753   1      }
 754          
 755          
 756          
 757          
 758          /**************************************************
 759          *º¯ÊýÃû³Æ£ºvoid TouchKey_LowPower_Dispose(void)
 760          *º¯Êý¹¦ÄÜ£dµÍ¹¦ºÄÉ¨ÃèÊý¾Ý´¦Àí
 761          *Èë¿Ú²ÎÊý£ºvoid
 762          *³ö¿Ú²ÎÊý£ºvoid  
 763          **************************************************/
 764          void TouchKey_LowPower_Dispose(void)
 765          {  
 766   1        int data differData; 
 767   1      
 768   1        unsigned char data WakeUpKey_Index;
 769   1      
 770   1        
 771   1        BTM_WakeUpFlag = 0;
 772   1      
 773   1        TRIG = 1;
 774   1          PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 775   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 776   1          _nop_();
 777   1          _nop_();
 778   1          _nop_();
 779   1          _nop_();
 780   1          _nop_();
 781   1          _nop_();
 782   1        _nop_();
 783   1      
 784   1          TRIG = 1;
 785   1          PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 786   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 787   1          _nop_();
 788   1          _nop_();
 789   1          _nop_();
 790   1          _nop_();
 791   1          _nop_();
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 14  

 792   1          _nop_();
 793   1        _nop_();
 794   1        
 795   1          
 796   1        for(WakeUpKey_Index=0; WakeUpKey_Index<WakeUpKeyNum; WakeUpKey_Index++)
 797   1        {
 798   2      
 799   2              WakeUpKeyValue = WakeUpKey_List[WakeUpKey_Index];
 800   2          TKCFG1 =  BaseLineAdjusttmp_Low[WakeUpKeyValue]; 
 801   2          TKTM = ScanTimeTemp_Low[WakeUpKeyValue];//ScanTimeTemp;
 802   2          TKCR = CurrentChannel_Low[WakeUpKeyValue];
 803   2      
 804   2              PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 805   2            _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 806   2              _nop_();
 807   2              _nop_();
 808   2              _nop_();
 809   2              _nop_();
 810   2              _nop_();
 811   2              _nop_();
 812   2            _nop_();       
 813   2      
 814   2              differData = (TKCNT<<ScanTimeCon)-BaseLine[WakeUpKeyValue] ; 
 815   2        
 816   2          if(differData >= SetFingerThresholdtmp_Low[WakeUpKeyValue])
 817   2            {
 818   3             SingleKeyFastScan_Flag = 1;
 819   3             break;       
 820   3            } 
 821   2      
 822   2               if(WakeUpNum==WakeUpKey_Index)
 823   2                  BaseLine[WakeUpKeyValue] += differData>>2;
 824   2        }
 825   1      
 826   1      
 827   1        if(++WakeUpNum>=BaselineUpdateCnt)
 828   1        {
 829   2          WakeUpNum = 0;
 830   2        }
 831   1      }
 832            
 833          /**************************************************
 834          *º¯ÊýÃû³Æ£ºvoid SingleKeyFastScan(void)
 835          *º¯Êý¹¦ÄÜ£dµ¥°´¼ü¿ìËÙÉ¨ÃèÄ£Ê½
 836          *Èë¿Ú²ÎÊý£ºvoid
 837          *³ö¿Ú²ÎÊý£ºvoid  
 838          **************************************************/
 839          void SingleKeyFastScan(void)
 840          { 
 841   1          unsigned char i;
 842   1          int differData; 
 843   1          int SetFingerThresholdtmp;
 844   1        
 845   1        SingleKeyFastScan_Flag = 0;
 846   1        TK_IE1 = TK_IE1|0x10; //´ò¿ªTKÖÐ¶Ï
 847   1        TKCFG1 = (TKCFG1 & 0X80) | BaseLineAdjusttmp[WakeUpKeyValue];
 848   1          TKCR = 0x80|CurrentChannel[WakeUpKeyValue]; 
 849   1        TKTM = ScanTimeTemp0*TKChannelCfg[WakeUpKeyValue][SCANTIME];
 850   1        
 851   1        for(i=0;i<TK_WakeUpConfirmTouchCnt;i++)
 852   1          {        
 853   2        
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 15  

 854   2           TRIG = 1;
 855   2           TKSleepMode();
 856   2           RawData[WakeUpKeyValue] = TKCNT << ScanTimeCon;
 857   2           FilterDataDeal(WakeUpKeyValue);
 858   2               differData = RawData[WakeUpKeyValue]-BaseLine[WakeUpKeyValue] ;
 859   2           SetFingerThresholdtmp = GetCurrFingerValue(WakeUpKeyValue);
 860   2      
 861   2           if(differData >= SetFingerThresholdtmp )
 862   2           {   
 863   3              TouchCnt[WakeUpKeyValue]++;  
 864   3           }             
 865   2           else
 866   2           {
 867   3            break;
 868   3           }
 869   2          }
 870   1        
 871   1          if(TouchCnt[WakeUpKeyValue]>=TK_WakeUpConfirmTouchCnt)
 872   1          {    
 873   2            AntiMisAwakeup(WakeUpKeyValue);
 874   2          }
 875   1          else
 876   1          {
 877   2              TouchCnt[WakeUpKeyValue] = 0;
 878   2          }
 879   1      }
 880          
 881          void  TKSleepMode(void)
 882          {
 883   1        PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 884   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 885   1          _nop_();
 886   1          _nop_();
 887   1          _nop_();
 888   1          _nop_();
 889   1          _nop_();
 890   1          _nop_();
 891   1        _nop_();
 892   1      }
 893          #endif
 894          /**************************************************
 895          *º¯ÊýÃû³Æ£ºvoid LowPower_Touchkey_Scan(void)
 896          *º¯Êý¹¦ÄÜ£dµÍ¹¦ºÄÄ£Ê½TKÉ¨Ãè
 897          *Èë¿Ú²ÎÊý£ºvoid
 898          *³ö¿Ú²ÎÊý£ºvoid  
 899          **************************************************/
 900          
 901          void LowPower_Touchkey_Scan(void)
 902          {               
 903   1        #ifdef  TK_LowPowerMode 
 904   1          unsigned char TEMP = 0;
 905   1          EA  = 0;
 906   1          OPINX = 0XC1;
 907   1          TEMP = OPREG;
 908   1          OPREG &= 0XCF;
 909   1          OPREG |= 0X10;
 910   1          
 911   1          TKCR &= 0x7f;//~0x80;
 912   1          EA  = 1;
 913   1          
 914   1        PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 915   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     05/23/2023 14:43:17 PAGE 16  

 916   1          _nop_();
 917   1          _nop_();
 918   1          _nop_();
 919   1          _nop_();
 920   1          _nop_();
 921   1          _nop_();
 922   1        _nop_();
 923   1          
 924   1          OPINX =  0XC1;
 925   1          OPREG = TEMP;
 926   1          
 927   1        TKCR |= 0x80; //´ò¿ªTKµçÔ´
 928   1      
 929   1        //½øÐÐ°´¼ü´¦Àí
 930   1        if(BTM_WakeUpFlag)
 931   1        {
 932   2          TouchKey_LowPower_Dispose();       //¼ì²â°´¼ü 
 933   2          CLRWDT();
 934   2          if( SingleKeyFastScan_Flag == 1)
 935   2          {                  
 936   3            SingleKeyFastScan();       //ÈôÓÐ°´¼üÐÅÏ¢½øÈëµ¥°´¼ü¿ìËÙ¶à´ÎÉ¨ÃèÈ·¶¨°´¼üÊÇ·ñÕæÊµÐÅºÅ¡£
 937   3          }
 938   2          LowPowerAwakeupDispose();
 939   2        }
 940   1        #endif    
 941   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2039    ----
   CONSTANT SIZE    =    138    ----
   XDATA SIZE       =    237      18
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     52       3
   IDATA SIZE       =     14    ----
   BIT SIZE         =      6    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
