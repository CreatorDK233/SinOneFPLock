C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE LOWPOWER
OBJECT MODULE PLACED IN .\Objects\LowPower.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Softwares\Application\LowPower.c LARGE OMF2 OPTIMIZE(9,SPEED) BROWSE INC
                    -DIR(.\Drivers\Lib\c;.\Drivers\Lib\H;.\Drivers\Lib\IAP_Lib;.\Drivers\Lib\TouchKey_lib;.\Drivers\Physical;.\Drivers\Protoc
                    -ol;.\Softwares\Application;.\Softwares\Basic;.\Softwares\ModuleLogic) DEBUG PRINT(.\Listings\LowPower.lst) TABS(2) OBJEC
                    -T(.\Objects\LowPower.obj)

line level    source

   1          #include "LowPower.h"
   2          #include "SensorMethod.h"
   3          #include "Project.h"
   4          #include "IO.h"
   5          #include "global_variable.h"
   6          #include "Basic_Function.h"
   7          #include "HallSlide.h"
   8          /*以下为休眠唤醒函数所需头文件*/
   9          #include "spi.h"
  10          #include "adc.h"
  11          #include "KeyScan.h"
  12          #include "GUI.h"
  13          #include "i2c.h"
  14          #include "Fingerprint.h"
  15          #include "MFC_WS1850.h"
  16          #include "BeepMgr.h"
  17          #include "tim.h"
  18          #include "usart.h"
  19          #include "RTC_PCF8563.h"
  20          #include "LCD.h"
  21          #include "Battery.h"
  22          
  23          extern bool_t IfSystemIsInFactoryDefaultStatus(void);
  24          
  25          extern bit Touch_WakeUpFlag;
  26          #ifdef Function_HallSlideCover
              extern  bit SleepingHallState;  //休眠时读到霍尔io口的电位值
              extern bit HallSleepFlag;       //霍尔休眠标志
              #endif
  30          
  31          #ifdef Function_USE_Internal_RTC
              unsigned  char  SecondCount = 0;
              #endif
  34          static uint8_t LastWakeUpKeyValue = 0xff;
  35          int8_t KeyWakeUpKeyWaitTime = 0;
  36          bit     KeyJustWakeUp = 0;
  37          
  38          /**************************************************
  39          *函数名称：void IntoLowPowerMode_Init(void)
  40          *函数功能：进入低功耗模式前的的初始化
  41          *入口参数：void
  42          *出口参数：void  
  43          *备注说明：在进入低功耗前，对部分数据进行处理 
  44          **************************************************/
  45          void IntoLowPowerMode_Init(void)
  46          {
  47   1          /*进入低功耗前设置*/
  48   1        KeyWakeUpKeyWaitTime = 8;//8*125ms = 1s
  49   1        #ifdef Function_HallSlideCover
                SleepingHallState = PINMACRO_HALLSENSOR_STATUS;
                HallSleepFlag = 0;
                #endif
C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 2   

  53   1      }
  54          
  55          /**************************************************
  56          *函数名称：void MX_QuitLowPowerMode(void)
  57          *函数功能d退出低功耗模式
  58          *入口参数：void
  59          *出口参数：void  
  60          **************************************************/
  61          void MX_QuitLowPowerMode(void)
  62          {
  63   1        TouchKey_QuitLowPowerMode();       
  64   1        Touch_WakeUpFlag = 1;
  65   1        INT1flag=0x00;
  66   1      }
  67          
  68          /**************************************************
  69          *函数名称：void AntiMisAwakeup(uint8_t KeyValue)
  70          *函数功能d防止偶然干扰造成自动唤醒
  71          *入口参数：uint8_t KeyValue
  72          *出口参数：void  
  73          **************************************************/
  74          void AntiMisAwakeup(uint8_t KeyValue)
  75          {
  76   1        if( KeyWakeUpKeyWaitTime <= 0 )
  77   1        {
  78   2          if(LastWakeUpKeyValue==KeyValue)
  79   2          {
  80   3            #ifdef Function_HallSlideCover
                    if( PINMACRO_HALLSENSOR_STATUS == 0 )
                    {
                      MX_QuitLowPowerMode();
                      KeyJustWakeUp = 1;
                      LastWakeUpKeyValue = 0xff;
                    }
                    #else
  88   3            MX_QuitLowPowerMode();
  89   3            KeyJustWakeUp = 1;
  90   3            LastWakeUpKeyValue = 0xff;
  91   3            #endif
  92   3          }
  93   2          else{
  94   3            LastWakeUpKeyValue = KeyValue;
  95   3          }
  96   2        }
  97   1        else{
  98   2          LastWakeUpKeyValue = 0xff;
  99   2        }
 100   1      }
 101          
 102          /**************************************************
 103          *函数名称：void LowPowerAwakeupDispose(void)
 104          *函数功能d低功耗唤醒检测（不带触摸按键检测）
 105          *入口参数：void
 106          *出口参数：void  
 107          **************************************************/
 108          void LowPowerAwakeupDispose(void)
 109          {
 110   1        if( PickAlarmEnableMgr.Enable == bTRUE )
 111   1        {
 112   2          if(( PINMACRO_PICKLOCK_STATUS == 1 )&&( AntiPryingMgr.AntiPryingSignalRelease == bTRUE ))
 113   2          {
 114   3            MX_QuitLowPowerMode();
C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 3   

 115   3          }
 116   2        }
 117   1        if(( PINMACRO_FPM_TOUCH_STATUS == 1 )||( PINMACRO_ONBOARD_BUTTON_STATUS == 0 ))
 118   1        {
 119   2          MX_QuitLowPowerMode();
 120   2        }
 121   1        #ifdef Function_HallSlideCover
                HallAwakeupDispose();
                #endif
 124   1        if( INT1flag != 0 )
 125   1        {
 126   2          MX_QuitLowPowerMode();
 127   2        }
 128   1      }
 129          
 130          /**************************************************
 131          *函数名称：void System_PowerDown(void)
 132          *函数功能d系统休眠开始
 133          *入口参数：void
 134          *出口参数：void  
 135          **************************************************/
 136          void System_PowerDown(void)
 137          {
 138   1        uint8_t i;
 139   1        
 140   1        static uint16_t FPtimeout_times,FP_SleepFailedTimes;
 141   1        
 142   1        CLRWDT();
 143   1        DEBUG_MARK;
 144   1        
 145   1        #ifdef Function_ScreenDisplay
 146   1        Clear_Screen();
 147   1        #endif
 148   1        
 149   1        #ifndef DEBUG_MODE
 150   1        SET_LOGLED_OFF;
 151   1        #endif
 152   1        
 153   1        ADC_DeInit();
 154   1        
 155   1        MX_TIM_DeInit();
 156   1      
 157   1        SPI0_DeInit();
 158   1      
 159   1        MFC_POWERDOWN();  
 160   1      
 161   1        VoicePlayerPowerDown();
 162   1      
 163   1        CLRWDT();
 164   1      
 165   1        FPtimeout_times=0;
 166   1        FP_SleepFailedTimes=0;
 167   1        while(1)
 168   1        {
 169   2          FpmAckMgr.Status = WaitACK;
 170   2          FPM_SendSleepCmd();
 171   2          for (i=0;i<25;i++)
 172   2          {
 173   3            CLRWDT();
 174   3            Hardware_DelayMs(20);
 175   3            FPM_Mgr_Task();
 176   3            if ( FpmAckMgr.Status == GotACK )
C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 4   

 177   3            {
 178   4              if (  ( FpmAckMgr.ErrorCode == Error_NONE)
 179   4                &&(PINMACRO_FPM_TOUCH_STATUS == 0 )
 180   4                )
 181   4              {
 182   5                FPMpowerMgr.Status = FPMpowerDown;  
 183   5                DEBUG_MARK;
 184   5                break;
 185   5              }
 186   4              else
 187   4              {
 188   5                FP_SleepFailedTimes++;
 189   5                DEBUG_MARK;
 190   5                
 191   5                if (FP_SleepFailedTimes>350)    //FP not released more than 10s
 192   5                {
 193   6                  FPMpowerMgr.Status = FPMpowerDown;  
 194   6                }
 195   5                break;
 196   5              }
 197   4              
 198   4            }
 199   3            else
 200   3            {
 201   4              if (i>23)   //time out,FP failed
 202   4              {
 203   5                FPtimeout_times++;
 204   5                if (FPtimeout_times>2)
 205   5                {
 206   6                  FPMpowerMgr.Status = FPMpowerDown;  
 207   6                  break;
 208   6                }
 209   5              }
 210   4            }
 211   3          }
 212   2          CLRWDT();
 213   2          if ( FPMpowerMgr.Status == FPMpowerDown)
 214   2          {
 215   3            DEBUG_MARK;
 216   3            MX_UART2_DeInit();
 217   3            SET_FPMPOWER_OFF; 
 218   3            Hardware_DelayMs(3);//Wait for Power line lost power
 219   3            break;
 220   3          }
 221   2        }
 222   1        #ifdef ProjectIs_BarLock_S6902
                  LEDsCtrlSwitch = 0;
                #endif
 225   1          //wait for user release touch button
 226   1        if ( SystemPowerMgr.SleepSource == UserForced )
 227   1        {
 228   2          for (i=0;i<10;i++)
 229   2          {
 230   3            CLRWDT();
 231   3            Hardware_DelayMs(1);
 232   3          }
 233   2        }
 234   1      
 235   1        MX_GPIO_DeInit();
 236   1        
 237   1        Enable_EX_Interrupt();
 238   1        
C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 5   

 239   1        IntoLowPowerMode_Init();
 240   1      
 241   1        TouchKey_IntoLowPowerMode();
 242   1        i=0;
 243   1        while(i!=1)
 244   1        {
 245   2          if(GetLowPowerScanFlag() == 0)  //正常运行模式 
 246   2          {
 247   3            i=1;
 248   3          }
 249   2          else            //低功耗运行模式
 250   2          {
 251   3            LowPower_Touchkey_Scan();
 252   3          } 
 253   2        }
 254   1      }
 255          
 256          /**************************************************
 257          *函数名称：void System_Awake(void)
 258          *函数功能d系统唤醒开始
 259          *入口参数：void
 260          *出口参数：void  
 261          **************************************************/
 262          void System_Awake(void)
 263          {
 264   1        uint8_t i;
 265   1        
 266   1        CLRWDT();
 267   1      
 268   1        Hardware_DelayMs(1);    //wait for system clock stable//
 269   1        
 270   1        MX_GPIO_Init();
 271   1        
 272   1        SET_MFC_RST_H;
 273   1        
 274   1        MX_ADC1_Init();
 275   1        
 276   1        MX_TIM_Init();
 277   1        
 278   1        MX_SPI0_Init();
 279   1        
 280   1        MX_I2C_Init();
 281   1        
 282   1        #ifndef DEBUG_MODE
 283   1        SET_LOGLED_ON;
 284   1        #endif
 285   1        
 286   1        #if (defined ProjectIs_BarLock_S6902)
                SET_LEDKEYs_OFF;
                #endif
 289   1        
 290   1        MX_UART2_Init();
 291   1        
 292   1        SET_POWER_ON;        
 293   1        FPMpowerMgr.Status = FPMpowerOn;
 294   1        Hardware_DelayMs(5);    //wait for OLED Driver power on reset
 295   1        
 296   1        MFC_Init();
 297   1        Hardware_DelayMs(5);  
 298   1        
 299   1        TouchKeyRestart();
 300   1        Key_Init();
C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 6   

 301   1        
 302   1        GUI_Init(); 
 303   1      
 304   1        SET_VOLUME(VoiceMgr.volume);
 305   1      
 306   1        Hardware_DelayMs(1);
 307   1        
 308   1        for (i=0;i<100;i++)
 309   1        {
 310   2          if( i%10 == 0 )CLRWDT();
 311   2          Hardware_Task_Analog();
 312   2          HardwareBatteryMgr_Task();
 313   2        }
 314   1        if (( BatteryMgr.BatteryLevel == LEVEL_1 )||( BatteryMgr.BatteryLevel == LEVEL_0 ))
 315   1        {
 316   2          PLAY_VOICE_ONESEGMENT(VOICE_PleaseReplaceTheBattery);
 317   2          BatteryMgr.TimeCnt = Def_MessageBoxTimeDelay;
 318   2          CurrentScreen = SCREEN_LowBattery;    
 319   2        }
 320   1        #ifdef INSIDEBUTTONINTOMAINMENU
                else if (SystemPowerMgr.AwakeSource == SystemResetKey)    
                {
                  if ( PINMACRO_ONBOARD_BUTTON_STATUS != 0 )
                  {
                    //TouchKeyStatus.KEY_INSIDEBUTTON_Pressed = bTRUE;
                    //SystemPowerMgr.AwakeSource = DoNotCare; 
                    CurrentScreen = SCREEN_ManagerIdentify;
                    ManagerIdentifyMgr.Status = StartManagerIdentify;
                  }
              
                } 
                #endif
 333   1        else
 334   1        {
 335   2          CurrentScreen = SCREEN_Main;
 336   2          PasscodeUserIdentifyMgr.Status = PasscodeIdentifyIdle;
 337   2          FpIdentifyMgr.Status = FPMcmdStart;
 338   2          CardIdentifyMgr.Status = ReadingCardID;
 339   2          if ( IfSystemIsInFactoryDefaultStatus()==bTRUE )
 340   2          {
 341   3            PLAY_VOICE_ONESEGMENT(VOICE_PleaseAddMasterFirst);
 342   3          }
 343   2          else
 344   2          {
 345   3            if (  (SystemPowerMgr.AwakeSource == CasingOpen)
 346   3              ||(SystemPowerMgr.AwakeSource == KeyBoardTouch)
 347   3              )
 348   3            {
 349   4              PLAY_VOICE_ONESEGMENT_FIXED(VOICE_POWERON); 
 350   4            }
 351   3          }
 352   2        }
 353   1        
 354   1        SystemPowerMgr.SleepSource = SleepTimer;
 355   1      
 356   1      #ifdef Function_FPMbreathingLed
 357   1        for(i=0;i<25;i++)
 358   1        {
 359   2          CLRWDT();
 360   2          FpmAckMgr.Status = WaitACK;
 361   2          FPM_SetBreathingLED(1,1,1,255);   //Blue LED breathing
 362   2          Hardware_DelayMs(20);
C51 COMPILER V9.60.0.0   LOWPOWER                                                          05/09/2023 16:27:45 PAGE 7   

 363   2          FPM_Mgr_Task();
 364   2          if ( FpmAckMgr.Status == GotACK )
 365   2          {
 366   3            break;
 367   3          }
 368   2        }
 369   1      #endif
 370   1        
 371   1      }
 372          
 373          /**************************************************
 374          *函数名称：void LowPowerTimer_ISR(void)
 375          *函数功能d低功耗模式下定时器中断服务函数（125ms调用一次）
 376          *入口参数：void
 377          *出口参数：void  
 378          **************************************************/
 379          void LowPowerTimer_ISR(void) 
 380          {
 381   1        #ifdef Function_USE_Internal_RTC
                SecondCount += 1;
                if( SecondCount >= 8 )
                {
                  SecondCount = 0;
                  G_SystemUTCTime += 1;
                }
                #endif
 389   1        if ( KeyWakeUpKeyWaitTime > 0 )
 390   1        {
 391   2          KeyWakeUpKeyWaitTime--;
 392   2        }
 393   1      }
 394          
 395          
 396          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    729    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      6       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
