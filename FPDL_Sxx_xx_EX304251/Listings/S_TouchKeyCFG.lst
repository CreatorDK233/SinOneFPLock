C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE S_TOUCHKEYCFG
OBJECT MODULE PLACED IN .\Objects\S_TouchKeyCFG.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Drivers\Lib\TouchKey_lib\S_TouchKeyCFG.C LARGE OMF2 OPTIMIZE(9,SPEED) BR
                    -OWSE INCDIR(.\Drivers\Lib\c;.\Drivers\Lib\H;.\Drivers\Lib\IAP_Lib;.\Drivers\Lib\TouchKey_lib;.\Drivers\Physical;.\Driver
                    -s\Protocol;.\Softwares\Application;.\Softwares\Basic;.\Softwares\ModuleLogic) DEBUG PRINT(.\Listings\S_TouchKeyCFG.lst) 
                    -TABS(2) OBJECT(.\Objects\S_TouchKeyCFG.obj)

line level    source

   1          //*************************************************************************************************
   2          //  Copyright (c)   ÉîÛÚÊÐÈüÔªÎ¢µç×ÓÓÐÏÞ¹«Ë¾
   3          //  ÎÄ¼þÃû³Æ  :  S_TouchKeyCFG.c
   4          //  ×÷Õß    : 
   5          //  Ä£¿é¹¦ÄÜ  :  
   6          //  °æ±¾    :
   7          //  ¸ü¸Ä¼ÇÂ¼  :
   8          //  ×¢ÒâÊÂÏî  :  ÓÃ»§ÐèÒªÅäÖÃµÄÎÄ¼þÔÚS_TouchKeyCFG.hÖÐ
   9          //  ¿â°æ±¾±ê¼Ç  : 
  10          //************************************************************************************************
  11          #include "S_TouchKeyCFG.h"
  12          #include "SC95F861xB_C.H"
  13          #include "LowPower.h"
  14          
  15          /***************ÐÍºÅÑ¡Ôñ***************/
  16          #define  SC95F8X3X      1 
  17          #define  SC92F8X8X      2
  18          #define  SC92F8X9X      3
  19          #define  SC92L8X3X      4
  20          #define  SC95F8X6X      5
  21          #define  SC95F8X1XB     6
  22          #define  SC95R605       7
  23          #define  MCU_TYPE   SC95R605    
  24          bit H_FLAG;
  25          //*************************************************************************************
  26          //     ¼Ä´æÆ÷¶¨Òå
  27          //*************************************************************************************
  28          
  29          /*PSW*/
  30          sfr   TK_PSW      =   0xD0;             //³ÌÐò×´Ì¬×Ö
  31          sbit  TK_CY   =   TK_PSW^7;           //½øÎ»  
  32          
  33          sfr   TK_IE1      =   0xA9;             //ÖÐ¶Ï¿ØÖÆ¼Ä´æ
  34          /*system*/
  35          //sfr   PCON      =   0x87;             //µçÔ´¹ÜÀí¿ØÖÆ¼Ä´æÆ÷
  36          
  37          //sfr   TKCR  = 0xE8;               //TouchKey¿ØÖÆ¼Ä´æÆ÷
  38          
  39          sfr   TKTMH = 0xE7;               //´¥Ãþ°´¼ü¶¨Ê±¼Ä´æÆ÷L
  40          sfr   TKTML = 0xE6;               //´¥Ãþ°´¼ü¶¨Ê±¼Ä´æÆ÷L
  41          sfr16   TKTM    =   0xE6;
  42          
  43          sfr   TKCNTH  = 0xE5;               //TouchKey¼ÆÊýÆ÷Öµ¸ß7Î»
  44          sfr   TKCNTL  = 0xE4;               //TouchKey¼ÆÊýÆ÷ÖµµÍ8Î»
  45          sfr16   TKCNT   =   0xE4;
  46          
  47          sfr   TKCFG2  = 0xE3;               //´¥Ãþ°´¼ü²Î¿¼µçÑ¹ÅäÖÃ¼Ä´æÆ÷
  48          sfr   TKCFG1  = 0xE2;               //TouchKeyÅäÖÃ¼Ä´æÆ÷2
  49          sfr   TKCFG0  = 0xE1;               //TouchKeyÅäÖÃ¼Ä´æÆ÷1
  50          
  51          /*TKCR*/
  52          //sbit  ENTKS = TKCR^7;               //TouchKey¿ª¹ØµçÔ´
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 2   

  53          sbit  TRIG  = TKCR^6;               //TouchKey´¥·¢¿ª¹Ø£ºÐ´1ÓÐÐ§£¬´¥·¢Ò»´ÎkeyÉ¨ÃèÖÜÆÚ
  54          sbit  TRIF  = TKCR^5;               //TouchKeyÖÐ¶Ï±êÖ¾
  55          
  56          //===========================================================================
  57          //È«¾Ö±äÁ¿¶¨Òå
  58          unsigned  char  xdata   SOCAPI_TouchKeyStatus;  //API½Ó¿Ú×´Ì¬£ºbit7-Ò»ÂÖÉ¨ÃèÍê³É±êÖ¾  1:Íê³É  0£ºÎ´Íê³É
  59                                      //         bit6-Í¨µÀ´¥Ãþ¼ÆÊýÒç³ö±êÖ¾ 1:Òç³ö  0:Î´Òç³ö
  60          //===============================================================================
  61          //È«¾Ö±äÁ¿ÉùÃ÷£º¸ÃÇøÓò²»¿ÉÐÞ¸Ä
  62          unsigned  int   xdata   RawData[SOCAPI_SET_TOUCHKEY_TOTAL];     
  63          unsigned  int   data    BaseLine[SOCAPI_SET_TOUCHKEY_TOTAL];
  64          unsigned    int   xdata   FilterData[SOCAPI_SET_TOUCHKEY_TOTAL];                        
  65          unsigned  char    xdata   RestAreaCnt[SOCAPI_SET_TOUCHKEY_TOTAL];       
  66          unsigned  char    xdata   TouchCnt[SOCAPI_SET_TOUCHKEY_TOTAL];        
  67          unsigned  char    xdata   NoTouchCnt[SOCAPI_SET_TOUCHKEY_TOTAL];        
  68          unsigned  char  xdata   CurrentChannel[SOCAPI_SET_TOUCHKEY_TOTAL];                 
  69          unsigned    char    xdata       LowFingerDataCnt[SOCAPI_SET_TOUCHKEY_TOTAL];
  70          unsigned  char    xdata   FloatAreaCnt[SOCAPI_SET_TOUCHKEY_TOTAL]; 
  71          unsigned  char  xdata       BaseLineAdjusttmp[SOCAPI_SET_TOUCHKEY_TOTAL];   
  72          int                 xdata       DifferAccum[SOCAPI_SET_TOUCHKEY_TOTAL]; 
  73          char              xdata   SetNoiseThreshold;
  74          unsigned  char  xdata   ConfirmTouchCnt;
  75          unsigned  char  xdata   MultipleDealTpye = 0; 
  76          
  77          //×Ô¶¨Òå±äÁ¿
  78          unsigned  int   xdata       UpdateBaseLNum;         // µ¥¼ü³¤°´¼ÆÊýÆ÷
  79          unsigned  int   xdata       MultipleLNum;         // ¶à°´¼ü¸ÉÈÅ¼ÆÊý
  80          bit   WakeUp_Flag = 0;
  81          
  82          //Íâ²¿±äÁ¿½Ó¿Ú
  83          extern  unsigned  char  data    CurrentChannelMax;    //µ±Ç°Ñ¡ÖÐµÄkeysensorµÄ¸öÊý
  84          extern  bit  bMultiple; //¶à°´¼ü±êÖ¾
  85          extern  unsigned  int     xdata       ScanTime;
  86            
  87          extern  bit  GetIsNeedUpdateBaseline(void);
  88          extern  void SetNeedUpdateBaseline(void);
  89          extern  unsigned long int SensorKeyFlag(void);
  90          extern  void MultipleDeal(unsigned char CycleCnt);
  91          extern  void FilterDataDeal(unsigned char i);
  92          extern  void TouchKey_Service(void);
  93          void  TKSleepMode(void);
  94          /***************µ¯»É¿â¶ÀÓÐ***************/
  95          #define   SOCAPI_SET_CS_FUNCTION            1   //0:±íÊ¾²»½øÐÐCS²âÊÔ,1: ±íÊ¾½øÐÐCS²âÊÔ,Ä¬ÈÏ0
  96          #define   SOCAPI_INHIBITION_ZONE              8   //ÒÖÖÆÇø¼ä%£¬ÉèÖÃ·¶Î§5-10£¬Ä¬ÈÏ7,¼´£¨7*10£©%=70% £¬Á¬Ë®Ê±¼Ó´ó¸Ã
             -²ÎÊý,¶Ô½²»úÉèÖÃÐ¡
  97          #define   SOCAPI_MAX_KEY_MUTIPLE            300   //¶àÉÙ´Î¸ÉÈÅ¸üÐÂ»ùÏß£¬Ä¬ÈÏ300*5=1500
  98          #define   SOCAPI_MAX_KEY_NUM_INVALID          3   //Ç¿ÖÆ¸üÐÂ»ùÏß°´¼üÏÞÖÆ¸öÊý£¬Ä¬ÈÏ3
  99          /****************************************/
 100          
 101          #define     AppType               0
 102          #define     IsDoubleKey           1
 103          #define     AirSeparationDistance       2
 104          #define     CONFIRMTOUCHCNT                 3
 105          #define     INIT_AUTO_UPDATE_TIME       4
 106          #define     SET_KEY_CONTI_TIME              5  
 107          #define     SET_SYNC_UPDATE         6
 108          #define     SET_UPDATE_SPEED        7 
 109          #define     AUTO_UPDATE_TIME            8
 110          #define     FilteredKValue          9
 111          #define     SET_ANTIJAM             10
 112          #define     BAUD                    11
 113          #define     DwellTime               12
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 3   

 114          #define     SaveTime              13
 115          #define     NOISE                           16
 116          
 117          #define     SET_TOUCH_FREQ          0
 118          #define     SET_RESOLUTION          1
 119          #define     SET_GAIN_CFG          2
 120          #define     SCANTIME            3
 121          #define     SET_ICHA            4
 122          #define     FINGER_THRESHOLD_H          6
 123          #define     FINGER_THRESHOLD_L          7
 124          
 125          //**********************************************************************************  
 126          //                µÍ¹¦ºÄÉèÖÃ                //
 127          //**********************************************************************************
 128          #define     TK_LowPowerMode                
 129          
 130          #ifdef  TK_LowPowerMode
 131          
 132          #define ScanTimeCon   3
 133          
 134          #define   BTM_TIMEBASE_15600US     0X00   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª15.6MS
 135          #define   BTM_TIMEBASE_31300US     0X01   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª31.3MS
 136          #define   BTM_TIMEBASE_62500US     0X02   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª62.5MS
 137          #define   BTM_TIMEBASE_125MS     0X03   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª125MS
 138          #define   BTM_TIMEBASE_250MS       0X04   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª250MS
 139          #define   BTM_TIMEBASE_500MS       0X05   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª500MS
 140          #define   BTM_TIMEBASE_1S          0X06   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª1S
 141          #define   BTM_TIMEBASE_2S          0X07   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª2S
 142          #define   BTM_TIMEBASE_4S          0X08   //µÍÆµÊ±ÖÓÖÐ¶ÏÊ±¼äÎª4S
 143          
 144          #include <intrins.h>
 145          
 146          #define      WakeUpKeyNum                      12                    //µÍ¹¦ºÄÄ£Ê½ÏÂÉ¨Ãè°´¼ü¸öÊý     
 147          #define      WakeUpKeyChannel                  0x0000F5FC           //µÍ¹¦ºÄÏÂÉ¨Ãè°´¼üµÄ¶ÔÓ¦Í¨µÀ 
 148          #define      TK_SeepTimervSetting              BTM_TIMEBASE_125MS   //µÍ¹¦ºÄÏÂ°´¼üÖ®¼äµÄÉ¨Ãè¼ä¸ô
 149          #define      TK_WakeUpConfirmTouchCnt          5          //µÍ¹¦ºÄÏÂÈ·ÈÏ°´¼ü´ÎÊý
 150          
 151          #if TK_SeepTimervSetting == BTM_TIMEBASE_4S             //µÍ¹¦ºÄÏÂ»ùÏß¸üÐÂ¼ä¸ô¶¨Òå
                #define  BaselineUpdateCnt  1                   
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_2S             
                #define  BaselineUpdateCnt  3
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_1S             
                #define  BaselineUpdateCnt  6
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_500MS          
                #define  BaselineUpdateCnt  12
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_250MS           
                #define  BaselineUpdateCnt  24
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_125MS
 162            #define  BaselineUpdateCnt  48
 163          #elif TK_SeepTimervSetting == BTM_TIMEBASE_62500US
                #define  BaselineUpdateCnt  96
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_31300US
                #define  BaselineUpdateCnt  192
              #elif TK_SeepTimervSetting == BTM_TIMEBASE_15600US
                #define  BaselineUpdateCnt  384                 
              #endif
 170          
 171          bit  LowPowerScan_Flag = 0;                                         //µÍ¹¦ºÄÉ¨Ãè±êÖ¾
 172          bit  SingleKeyFastScan_Flag = 0;                                    //µ¥°´¼ü¿ìËÙÉ¨Ãè±êÖ¾
 173          bit  BTM_WakeUpFlag =0;                       //BTM»½ÐÑ±êÖ¾Î»
 174          bit  Touch_WakeUpFlag=0;                      //°´¼ü»½ÐÑ±êÖ¾Î»
 175          
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 4   

 176          unsigned    char    idata       WakeUpKey_List[WakeUpKeyNum];
 177          unsigned  char  idata       WakeUpThenScanCount = 0; 
 178          unsigned  int   WakeUpNum;                    //»½ÐÑ´ÎÊý¼ÆÊý--ÓÃÓÚµÍ¹¦ºÄÏÂ¸üÐÂ»ùÏß
 179          unsigned  char  WakeUpKeyValue;                 //==WakeUpKey_List[WakeUpKey_Index]
 180          unsigned  int   ScanTimeTemp0;                  //==ScanTime>>4
 181          
 182          
 183           void Customer_IntoLowPowerMode_Init(void);
 184           void Customer_QuitLowPowerMode_Init(void);
 185           void Customer_BTM_Dispose(void);
 186          
 187          //**********************************************************************************
 188          /**************************************************
 189          *º¯ÊýÃû³Æ£ºvoid Customer_IntoLowPowerMode_Init(void)
 190          *º¯Êý¹¦ÄÜ£ºÓÃ»§½øÈëµÍ¹¦ºÄÄ£Ê½Ç°µÄµÄ³õÊ¼»¯
 191          *Èë¿Ú²ÎÊý£ºvoid
 192          *³ö¿Ú²ÎÊý£ºvoid  
 193          *±¸×¢ËµÃ÷£ºÔÚ½øÈëµÍ¹¦ºÄÇ°£¬ÓÃ»§ÐèÒª¹Ø±ÕÍâÎ§ºÄµçµÄµçÂ·£¬Ê¹µçÁ÷×îµÍ
 194          *        ¸Ãº¯ÊýÒÑÔÚS_TouchKeyCFG.CÎÄ¼þTouchKey_IntoLowPowerMode()º¯ÊýÖÐµ÷ÓÃ,ÓÃ»§ÎÞÐèµ÷ÓÃ
 195          **************************************************/
 196          void Customer_IntoLowPowerMode_Init(void)
 197          {
 198   1          /*½øÈëµÍ¹¦ºÄÇ°ÉèÖÃ*/
 199   1        //¸Ãº¯ÊýÒÑÔÚTouchKey_IntoLowPowerMode()Àïµ÷ÓÃ
 200   1        
 201   1        //ÓÃ»§ÎÞÐèµ÷ÓÃ¸Ãº¯Êý£¡£¡£¡
 202   1        
 203   1        //ÓÃ»§ÐèÒª×Ô¼º±àÐ´¸Ãº¯ÊýÊµÌå£¡£¡£¡
 204   1      
 205   1        //¹Ø±ÕºÄµçµÄÍâÉè£¬±£³Ö×îµÍ¹¦ºÄ
 206   1      
 207   1      }
 208          /**************************************************
 209          *º¯ÊýÃû³Æ£ºvoid Customer_QuitLowPowerMode_Init(void)
 210          *º¯Êý¹¦ÄÜ£ºÓÃ»§ÍË³öµÍ¹¦ºÄÄ£Ê½ºóµÄµÄ³õÊ¼»¯
 211          *Èë¿Ú²ÎÊý£ºvoid
 212          *³ö¿Ú²ÎÊý£ºvoid
 213          *±¸×¢ËµÃ÷£ºÔÚÍË³öµÍ¹¦ºÄÇ°£¬ÓÃ»§½øÐÐµÄ±ØÒª²Ù×÷
 214          *      ¸Ãº¯ÊýÒÑÔÚS_TouchKeyCFG.cÎÄ¼þTouchKey_QuitLowPowerMode()º¯ÊýÖÐµ÷ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
 215          **************************************************/
 216          void Customer_QuitLowPowerMode_Init(void)
 217          {
 218   1         /*ÍË³öµÍ¹¦ºÄÇ°ÉèÖÃ*/
 219   1         
 220   1         //¸Ãº¯ÊýÒÑÔÚµÍ¹¦ºÄÏÂÂú×ãTK»½ÐÑÍË³öµÍ¹¦ºÄÊ±µ÷ÓÃ£¬¼´ÔÚTouchKey_QuitLowPowerMode()ÖÐµ÷ÓÃ
 221   1      
 222   1         //ÓÃ»§ÎÞÐèµ÷ÓÃ¸Ãº¯Êý£¡£¡£¡
 223   1       
 224   1         //ÓÃ»§ÐèÒª×Ô¼º±àÐ´¸Ãº¯ÊýÊµÌå£¡£¡£¡
 225   1      
 226   1         //»Ö¸´±ØÒªµÄÍâÉè
 227   1      }
 228          /**************************************************
 229          *º¯ÊýÃû³Æ£ºvoid Customer_BTM_Dispose(void)
 230          *º¯Êý¹¦ÄÜ£ºÓÃ»§BTM»½ÐÑºó×Ô¼ºµÄ´¦Àíº¯Êý
 231          *Èë¿Ú²ÎÊý£ºvoid
 232          *³ö¿Ú²ÎÊý£ºvoid  
 233          *±¸×¢ËµÃ÷£ºµÍ¹¦ºÄÊµÏÖÀûÓÃÁËBTM×ÊÔ´£¬ÓÃ»§ÐèÒªÔÚBTMÖÐÊµÏÖµÄÄÚÈÝÔÚ´Ëº¯ÊýÊµÏÖ
 234                 ¸Ãº¯ÊýÒÑÔÚS_TouchKeyCFG.cÎÄ¼þLowPower_Touchkey_Scan()º¯ÊýÖÐµ÷ÓÃ
 235          **************************************************/
 236          void Customer_BTM_Dispose(void)
 237          {
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 5   

 238   1         //¸Ãº¯ÊýÒÑÔÚµÍ¹¦ºÄÄ£Ê½É¨Ãèº¯ÊýÖÐµ÷ÓÃ
 239   1      
 240   1         //´Ëº¯ÊýÎªBTM¶¨Ê±»½ÐÑºó£¬ÓÃ»§µÄ´¦Àíº¯Êý
 241   1      
 242   1         //µÍ¹¦ºÄÄ£Ê½ÏÂ£¬ÓÃ»§ÐèÔÚBTMÖÐÊµÏÖµÄ¹¦ÄÜ¿ÉÔÚ´Ëº¯ÊýÊµÏÖ   
 243   1      
 244   1         //±ÈÈç²éÑ¯Ä³¸öIO£¬µçÆ½·¢Éú±ä»¯µÈÌõ¼þ³ÉÁ¢£¬(TK»½ÐÑ³ýÍâ)ÐèÍË³öµÍ¹¦ºÄÄ£Ê½¿ÉÔÚ´Ëº¯ÊýÖÐµ÷ÓÃTouchKey_QuitLowP
             -owerMode()
 245   1      
 246   1         /*
 247   1         if(TEST_IO == 0)
 248   1         {
 249   1         //do someing
 250   1         TouchKey_QuitLowPowerMode();
 251   1         }
 252   1         */
 253   1      
 254   1      }
 255          /**************************************************
 256          *º¯ÊýÃû³Æ£ºvoid BtmInit(void) 
 257          *º¯Êý¹¦ÄÜ£º
 258          *Èë¿Ú²ÎÊý£ºvoid 
 259          *³ö¿Ú²ÎÊý£ºvoid
 260          **************************************************/
 261          void BTM_Init(void)
 262          {
 263   1          BTMCON = BTMCON & 0XF0 | TK_SeepTimervSetting;
 264   1          BTMCON |= 0X80;
 265   1        TK_IE1 |= 0X04;
 266   1      }
 267          /**************************************************
 268          *º¯ÊýÃû³Æ£ºvoid BtmInit(void) interrupt 0
 269          *º¯Êý¹¦ÄÜ£ºBtmÖÐ¶Ï·þÎñº¯Êý
 270          *Èë¿Ú²ÎÊý£ºvoid 
 271          *³ö¿Ú²ÎÊý£ºvoid
 272          **************************************************/
 273          void BtmInit(void) interrupt  9
 274          {
 275   1         BTM_WakeUpFlag = 1;
 276   1        LowPowerTimer_ISR();
 277   1      
 278   1      }
 279          #endif
 280          
 281          //**********************************************************************************  
 282          //                º¯Êý½Ó¿Úµ÷ÓÃ²¿·Ö                  //
 283          //**********************************************************************************
 284          /**************************************************
 285          *º¯ÊýÃû³Æ£ºunsigned int SetOneKeyPushResetTime(void) 
 286          *º¯Êý¹¦ÄÜ£º°´¼ü×î³¤µÄÊä³öÊ±¼ä
 287          *Èë¿Ú²ÎÊý£ºvoid
 288          *³ö¿Ú²ÎÊý£ºunsigned int SOCAPI_SET_KEY_CONTI_TIME
 289          *±¸×¢  £ºÕâ¸ö·µ»ØÖµµÄÉèÖÃ£¬ ÊÇ¸ù¾ÝÓÐ¶à³¤Ê±¼äÆô¶¯TouchKeyRestart£¨£©Ò»´Î
 290          ÀýÈç10ms Æô¶¯Ò»´Î£¬ ÄÇSOCAPI_SET_KEY_CONTI_TIME*10ms£¬³¬¹ýÊ±¼äºó´Ë°´¼üÎÞÐ§¡£
 291          **************************************************/
 292          unsigned int SetOneKeyPushResetTime(void)   
 293          {   
 294   1        return  TKCFG[SET_KEY_CONTI_TIME];
 295   1      }
 296          /**************************************************
 297          *º¯ÊýÃû³Æ£ºint  GetBaselineUpdateThreshold(void)
 298          *º¯Êý¹¦ÄÜ£º¸üÐÂËÙ¶È 
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 6   

 299          *Èë¿Ú²ÎÊý£ºvoid
 300          *³ö¿Ú²ÎÊý£º  int 
 301          *±¸×¢  £º
 302          **************************************************/
 303          int  GetBaselineUpdateThreshold(void)
 304          {
 305   1        return TKCFG[SET_UPDATE_SPEED]; 
 306   1      }
 307          
 308          /**************************************************
 309          *º¯ÊýÃû³Æ£ºunsigned char GetInitAutoUpdateTime(void)
 310          *º¯Êý¹¦ÄÜ£º³õÊ¼»¯×Ô¶¯Ð£×¼´ÎÊý
 311          *Èë¿Ú²ÎÊý£ºvoid
 312          *³ö¿Ú²ÎÊý£ºunsigned  char 
 313          *±¸×¢  £º
 314          **************************************************/
 315          unsigned char GetInitAutoUpdateTime(void)
 316          {
 317   1        return  TKCFG[INIT_AUTO_UPDATE_TIME];
 318   1      }
 319          /**************************************************
 320          *º¯ÊýÃû³Æ£ºunsigned char GetCsFunction(void)
 321          *º¯Êý¹¦ÄÜ£º½øÐÐCS ²âÊÔ
 322          *Èë¿Ú²ÎÊý£ºvoid
 323          *³ö¿Ú²ÎÊý£ºchar SOCAPI_SET_CS_FUNCTION
 324          *±¸×¢  £º
 325          **************************************************/
 326          unsigned char GetCsFunction(void)
 327          {
 328   1        return SOCAPI_SET_CS_FUNCTION; 
 329   1      }
 330          /**************************************************
 331          *º¯ÊýÃû³Æ£ºint  GetCurrFingerValue(unsigned char i)
 332          *º¯Êý¹¦ÄÜ£º»ñÈ¡µ±Ç°µÄfinger Öµ
 333          *Èë¿Ú²ÎÊý£ºunsigned char
 334          *³ö¿Ú²ÎÊý£ºint 
 335          *±¸×¢  £º
 336          **************************************************/
 337          unsigned int   GetCurrFingerValue(unsigned char i)
 338          { 
 339   1        return  TKChannelCfg[i][FINGER_THRESHOLD_H]*256+TKChannelCfg[i][FINGER_THRESHOLD_L] ;
 340   1      }
 341          
 342          /**************************************************
 343          *º¯ÊýÃû³Æ£ºunsigned char  GetScanTimeValue(unsigned char i)
 344          *º¯Êý¹¦ÄÜ£º»ñÈ¡µ±Ç°Í¨µÀµÄÉ¨ÃèÊ±¼ä
 345          *Èë¿Ú²ÎÊý£ºunsigned char
 346          *³ö¿Ú²ÎÊý£ºunsigned char 
 347          *±¸×¢  £º
 348          **************************************************/
 349          unsigned char  GetScanTimeValue(unsigned char i)
 350          { 
 351   1        return TKChannelCfg[i][SCANTIME];
 352   1      }
 353          /**************************************************
 354          *º¯ÊýÃû³Æ£ºunsigned char IsDoubleKeyOrSlideKey(void)
 355          *º¯Êý¹¦ÄÜ£º¼ì²âÊÇ·ñÊÇµ¯»É»¬Ìõ»òÕßË«¼ü
 356          *Èë¿Ú²ÎÊý£ºvoid
 357          *³ö¿Ú²ÎÊý£ºunsigned char 
 358          *±¸×¢  £º
 359          **************************************************/
 360          unsigned char IsDoubleKeyOrSlideKey(void)
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 7   

 361          {
 362   1          return TKCFG[IsDoubleKey];
 363   1      }
 364          /**************************************************
 365          *º¯ÊýÃû³Æ£ºunsigned char  GetBaseLineAdjustValue(unsigned char i)
 366          *º¯Êý¹¦ÄÜ£º»ñÈ¡µ±Ç°Í¨µÀµÄ»ùÏßµ÷Õû
 367          j
 368          *Èë¿Ú²ÎÊý£ºunsigned char
 369          *³ö¿Ú²ÎÊý£ºunsigned char 
 370          *±¸×¢  £º
 371          **************************************************/
 372          unsigned char  GetBaseLineAdjustValue(unsigned char i)
 373          { 
 374   1           return BaseLineAdjusttmp[i]; 
 375   1      }
 376          /**************************************************
 377          *º¯ÊýÃû³Æ£ºunsigned char GetUpConfirmCnt(void)
 378          *º¯Êý¹¦ÄÜ£º¼ì²â°´¼üµ¯Æð´ÎÊý
 379          *Èë¿Ú²ÎÊý£ºvoid
 380          *³ö¿Ú²ÎÊý£º·µ»Ø°´¼üµ¯ÆðÈ·ÈÏ´ÎÊý 
 381          *±¸×¢  £º
 382          **************************************************/
 383          unsigned char GetUpConfirmCnt(void)
 384          {
 385   1        return ConfirmTouchCnt>>1;
 386   1      }
 387          /**************************************************
 388          *º¯ÊýÃû³Æ£ºunsigned char GetTKYzCnt(void)
 389          *º¯Êý¹¦ÄÜ£º»ñÈ¡°´¼üÒÖÖÆÈ·ÈÏ´ÎÊý
 390          *Èë¿Ú²ÎÊý£ºvoid
 391          *³ö¿Ú²ÎÊý£º·µ»ØÒÖÖÆ´ÎÊý 
 392          *±¸×¢  £º
 393          **************************************************/
 394          
 395          unsigned char GetTKYzCnt(void)
 396          {
 397   1        return (ConfirmTouchCnt/3);
 398   1      }
 399          
 400          /**************************************************
 401          *º¯ÊýÃû³Æ£ºint GetTKYzThreshold(unsigned char i)
 402          *º¯Êý¹¦ÄÜ£º»ñÈ¡°´¼üÒÖÖÆÇø¼ä
 403          *Èë¿Ú²ÎÊý£ºunsigned char i
 404          *³ö¿Ú²ÎÊý£º·µ»ØÒÖÖÆÇø¼ä
 405          *±¸×¢  £º
 406          **************************************************/
 407          unsigned int GetTKYzThreshold(unsigned char i)
 408          { 
 409   1        unsigned int SetFingerThresholdtmp; 
 410   1        
 411   1        SetFingerThresholdtmp = GetCurrFingerValue(i); 
 412   1          SetFingerThresholdtmp = SetFingerThresholdtmp*SOCAPI_INHIBITION_ZONE/10;
 413   1      
 414   1        return SetFingerThresholdtmp;
 415   1      }
 416          /**************************************************
 417          *º¯ÊýÃû³Æ£ºvoid CurrentSensorChoose(void)
 418          *º¯Êý¹¦ÄÜ£ºµ±Ç°Í¨µÀÑ¡Ôñ
 419          *Èë¿Ú²ÎÊý£ºvoid
 420          *³ö¿Ú²ÎÊý£ºvoid
 421          *±¸×¢  £º
 422          **************************************************/
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 8   

 423          void CurrentSensorChoose(void)
 424          {
 425   1        unsigned char   i = 0;
 426   1        unsigned char   Ctk_Channel_mark = 0;
 427   1        unsigned char   WakeUpKey_Channel_mark = 0;
 428   1        unsigned long int CurrentSensorKey = 0 ; 
 429   1        
 430   1        CurrentSensorKey = SOCAPI_SET_TOUCHKEY_CHANNEL; 
 431   1          
 432   1        for(i=0;i<31;i++)
 433   1        {
 434   2          CurrentSensorKey=CurrentSensorKey>>1;
 435   2          if(TK_CY)
 436   2          {
 437   3            CurrentChannel[Ctk_Channel_mark] = i;           //Ñ¡Ôñ´¥Ãþµ±Ç°µÄÍ¨µÀ
 438   3                  #ifdef  TK_LowPowerMode
 439   3            if(WakeUpKey_Channel_mark<WakeUpKeyNum)
 440   3                  {
 441   4                      if((WakeUpKeyChannel&((unsigned long int)1<<i)))
 442   4                      {
 443   5                          WakeUpKey_List[WakeUpKey_Channel_mark++] = Ctk_Channel_mark;
 444   5                      }
 445   4                  }
 446   3                  #endif
 447   3            Ctk_Channel_mark++;
 448   3            if(Ctk_Channel_mark >= SOCAPI_SET_TOUCHKEY_TOTAL)
 449   3              break;
 450   3          }   
 451   2        }
 452   1        CurrentChannelMax = Ctk_Channel_mark;             //µ±Ç°Ñ¡ÔñµÄ°´¼üÊý 
 453   1      }
 454          
 455          /**************************************************
 456          *º¯ÊýÃû³Æ£ºunsigned char  GetCfgMsg(unsigned char i)
 457          *º¯Êý¹¦ÄÜ£º»ñÈ¡Touch KEY ÅäÖÃÐÅÏ¢
 458          *Èë¿Ú²ÎÊý£ºvoid
 459          *³ö¿Ú²ÎÊý£ºint 
 460          *±¸×¢  £º
 461          **************************************************/
 462          unsigned char  GetCfgMsg(unsigned char i)
 463          {
 464   1        switch(i)
 465   1        { 
 466   2           case 0:  return TKChannelCfg[0][SET_TOUCH_FREQ];
 467   2           case 1:  return TKChannelCfg[0][SET_RESOLUTION];
 468   2           case 2:  return TKChannelCfg[0][SET_GAIN_CFG];
 469   2           case 3:  return GetBaseLineAdjustValue(0); //TKChannelCfg[0][SET_GAIN_CFG];
 470   2           case 4:  return TKCFG[SET_ANTIJAM];
 471   2           default:return 0;    
 472   2        }
 473   1      }
 474          
 475          /**************************************************
 476          *º¯ÊýÃû³Æ£ºvoid TouchKeyCFGInit(void)
 477          *º¯Êý¹¦ÄÜ£º³õÊ¼»¯TK¼Ä´æÆ÷
 478          *Èë¿Ú²ÎÊý£ºvoid
 479          *³ö¿Ú²ÎÊý£ºvoid
 480          *±¸×¢  £º
 481          **************************************************/
 482          void TouchKeyCFGInit(void)
 483          {
 484   1        unsigned char   i;
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 9   

 485   1        ConfirmTouchCnt = TKCFG[CONFIRMTOUCHCNT];
 486   1        SetNoiseThreshold = TKCFG[NOISE];
 487   1        CurrentSensorChoose(); 
 488   1         for(i=0;i<CurrentChannelMax;i++)
 489   1        {
 490   2          BaseLineAdjusttmp[i] =TKChannelCfg[i][SET_ICHA];; 
 491   2        } 
 492   1        UpdateBaseLNum = 0;
 493   1          #ifdef  TK_LowPowerMode
 494   1          BTM_Init();
 495   1          #endif 
 496   1      }
 497          
 498          /**************************************************
 499          *º¯ÊýÃû³Æ£ºunsigned int TouchKeyScan(void)
 500          *º¯Êý¹¦ÄÜ£º¼ì²â°´¼ü½Ó¿Ú
 501          *Èë¿Ú²ÎÊý£ºvoid
 502          *³ö¿Ú²ÎÊý£º°´¼üÍ¨µÀ£¬ ·µ»ØµÄÊÇÒ»¸öint , Í¨µÀÊý
 503          *±¸×¢  £º1,  µ÷ÓÃ´¥¿Ø¿â¼ì²âº¯ÊýSensorKeyFlag()
 504                 2,  ·ÖÎöµÃ³ö16¸öÍ¨µÀ£¬ÄÄ¸öÍ¨µÀÓÐ°´ÏÂ£¬°´ÏÂbit Î»ÉèÖÃÎª1£¬·ñÔòÎª0
 505                 3,  ¼ì²âÊÇ·ñÐèÒªÁ¢¼´¸üÐÂbaseline:  ´óÓÚMAX_KEY_RESET_BASELINE ¸ö°´¼ü°´ÏÂÊ±Á¢¼´¸üÐÂbaseline
 506                 4,  Ë«¼ü»òÕßµ¥¼ü°´ÏÂÊ±£¬ Ê±¼ä´óÓÚSetOneKeyPushResetTime()½á¹ûÊ±¸üÐÂbaseline 
 507          **************************************************/
 508          unsigned char OffHandCount = 0;
 509          unsigned int  NumCount = 0;
 510          unsigned long int TouchKeyScan(void)
 511          {
 512   1        unsigned char t;
 513   1          unsigned char MultipleCnt = 0;//°´¼ü¼ÆÊý
 514   1        unsigned long int Keyvalue = 0; 
 515   1        unsigned long int KeyData = 0;  
 516   1        int WakeupDiffData = 0; 
 517   1        int WakeupSetFingerThresholdtmp;
 518   1        
 519   1        
 520   1        if(WakeUp_Flag == 0)
 521   1        {
 522   2          if(GetIsNeedUpdateBaseline() == 0)        //¼ì²âÊÇ·ñÐèÒª¸üÐÂbaseline 
 523   2          {
 524   3            Keyvalue = SensorKeyFlag();         //SensorÅÐ¶Ï, ÕâÀïÈç¹ûbMultiple = 1 ±íÊ¾ÖÐ¼äÓÐ¸ÉÈÅ   //·ÖÎö°´¼ü£¬µÃ³ö±ê×
             -¼µÄ16Í¨µÀbit Î»                                      
 525   3            for(t=0;t<CurrentChannelMax;t++)
 526   3            {
 527   4              Keyvalue = Keyvalue>>1;
 528   4              if(TK_CY)
 529   4              {
 530   5                KeyData |= ((unsigned long int)0x01 << (CurrentChannel[t]));              
 531   5                MultipleCnt++;              
 532   5              }
 533   4            }                
 534   3            if(MultipleCnt >= 2)              //½øÈë¶à°´¼ü´¦Àí
 535   3            {     
 536   4              bMultiple = 1;      
 537   4              if(MultipleCnt >= SOCAPI_MAX_KEY_NUM_INVALID)
 538   4              {
 539   5                SetNeedUpdateBaseline();        // Á¢¼´¸üÐÂbaseline ,ÀýÈçÑÇ¿ËÁ¦°å¸ÇÉÏÈ¥
 540   5              }
 541   4              else
 542   4              {         
 543   5                if(IsDoubleKeyOrSlideKey())
 544   5                {
 545   6                  bMultiple = 0;
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 10  

 546   6                }          
 547   5              }     
 548   4            }     
 549   3        
 550   3            if(bMultiple == 0)                //½øÈë°´¼üÅÐ¶Ï
 551   3            {   
 552   4              if(KeyData != 0x0)                //µ¥¸ö°´¼ü´ïµ½¶à³¤Ê±¼ä¾Íupdate baseline ,ËÉÊÖ¼ì²â
 553   4              {     
 554   5                UpdateBaseLNum++; 
 555   5              }
 556   4              else  
 557   4              {
 558   5                UpdateBaseLNum = 0;   
 559   5              } 
 560   4            } 
 561   3            else
 562   3            {   
 563   4                //¿¼ÂÇ»ùÏß¸üÐÂ    
 564   4              MultipleLNum++; 
 565   4              KeyData = 0x00;
 566   4            }
 567   3        
 568   3            if(UpdateBaseLNum > SetOneKeyPushResetTime()) //°´¼ü³¬³ö×î³¤Êä³öÊ±¼ä¸üÐÂ»ùÏß
 569   3            {
 570   4              SetNeedUpdateBaseline(); 
 571   4              UpdateBaseLNum = 0;
 572   4            }
 573   3                
 574   3            if(MultipleLNum >SOCAPI_MAX_KEY_MUTIPLE)    //¸ÉÈÅ¼ÆÊý´óÓÚ×î´ó¼ÆÊý¸üÐÂ»ùÏß
 575   3            {
 576   4              SetNeedUpdateBaseline(); 
 577   4              MultipleDealTpye = 1; 
 578   4              MultipleLNum = 0;
 579   4            }  
 580   3          }     
 581   2          else
 582   2          {
 583   3            MultipleDeal(TKCFG[AUTO_UPDATE_TIME]);      //»ùÏß¸´Î»´¦Àí
 584   3          }
 585   2        }
 586   1        else
 587   1        {
 588   2              #ifdef  TK_LowPowerMode
 589   2          
 590   2          if(Touch_WakeUpFlag==1)
 591   2          {
 592   3            KeyData |= ((unsigned long int)0x01 << (CurrentChannel[WakeUpKeyValue]));
 593   3      
 594   3            WakeupDiffData = RawData[WakeUpKeyValue]-BaseLine[WakeUpKeyValue];
 595   3            WakeupSetFingerThresholdtmp = GetCurrFingerValue(WakeUpKeyValue);
 596   3      
 597   3            if(WakeupDiffData <= (WakeupSetFingerThresholdtmp-((WakeupSetFingerThresholdtmp)>>2)))
 598   3            { 
 599   4              NumCount=0;
 600   4              if(++OffHandCount>5)
 601   4              {
 602   5                OffHandCount = 0;
 603   5                WakeUp_Flag = 0;
 604   5                Touch_WakeUpFlag=0;
 605   5                KeyData = 0;
 606   5              }
 607   4              for(t=0;t<CurrentChannelMax;t++)
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 11  

 608   4              {
 609   5                FilterDataDeal(t);
 610   5                if(!WakeUp_Flag)
 611   5                {
 612   6                  if(WakeUpKeyValue == t)
 613   6                  continue;
 614   6                  BaseLine[t] = RawData[t]; 
 615   6                }
 616   5              }
 617   4                
 618   4            }
 619   3            else
 620   3            {
 621   4              OffHandCount=0;
 622   4              if(++NumCount > SetOneKeyPushResetTime()) //°´¼ü³¬³ö×î³¤Êä³öÊ±¼ä¸üÐÂ»ùÏß
 623   4              {
 624   5                SetNeedUpdateBaseline(); 
 625   5                NumCount = 0;
 626   5                WakeUp_Flag = 0;
 627   5                Touch_WakeUpFlag=0;
 628   5                KeyData = 0;
 629   5              }   
 630   4            }
 631   3          }
 632   2          else
 633   2          {
 634   3            if(++WakeUpThenScanCount>5)
 635   3            {
 636   4              WakeUpThenScanCount = 0;
 637   4              WakeUp_Flag = 0;
 638   4            }
 639   3            for(t=0;t<CurrentChannelMax;t++)
 640   3            {
 641   4              FilterDataDeal(t);
 642   4              if(!WakeUp_Flag)
 643   4              {
 644   5                BaseLine[t] = RawData[t]; 
 645   5              } 
 646   4            }
 647   3          }
 648   2          
 649   2          #endif
 650   2        }  
 651   1        return KeyData;
 652   1      }
 653          
 654          /**************************************************
 655          *º¯ÊýÃû³Æ£ºvoid CTK_ISR(void) interrupt 11
 656          *º¯Êý¹¦ÄÜ£º´¥ÃþÖÐ¶Ï·þÎñº¯Êý
 657          *Èë¿Ú²ÎÊý£ºvoid
 658          *³ö¿Ú²ÎÊý£ºvoid
 659          *±¸×¢  £º
 660          **************************************************/
 661          void CTK_ISR(void) interrupt  11
 662          {
 663   1         TouchKey_Service();
 664   1      }
 665          
 666          /**************************************************
 667          *º¯ÊýÃû³Æ£ºbit GetLowPowerScanFlag(void)
 668          *º¯Êý¹¦ÄÜ£d»ñÈ¡µÍ¹¦ºÄÄ£Ê½
 669          *Èë¿Ú²ÎÊý£ºvoid
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 12  

 670          *³ö¿Ú²ÎÊý£ºvoid  
 671          **************************************************/
 672          bit GetLowPowerScanFlag(void)
 673          {
 674   1          #ifdef  TK_LowPowerMode
 675   1          return LowPowerScan_Flag;
 676   1          #endif
 677   1      }
 678          
 679          /**************************************************
 680          *º¯ÊýÃû³Æ£ºvoid TouchKey_LowPower_Init(unsigned char i)
 681          *º¯Êý¹¦ÄÜ£dµÍ¹¦ºÄ³õÊ¼»¯
 682          *Èë¿Ú²ÎÊý£ºvoid
 683          *³ö¿Ú²ÎÊý£ºvoid  
 684          **************************************************/
 685          unsigned  char    xdata       BaseLineAdjusttmp_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 686          unsigned  char  xdata       CurrentChannel_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 687          unsigned  int   xdata       ScanTimeTemp_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 688          int   data       SetFingerThresholdtmp_Low[SOCAPI_SET_TOUCHKEY_TOTAL];
 689          void TouchKey_LowPower_Init(void)
 690          {
 691   1          unsigned char i;
 692   1            
 693   1          for(i=0;i<WakeUpKeyNum;i++)
 694   1          {
 695   2            WakeUpKeyValue = WakeUpKey_List[i];
 696   2            ScanTimeTemp_Low[WakeUpKeyValue] = ScanTimeTemp0*TKChannelCfg[WakeUpKeyValue][SCANTIME];
 697   2            BaseLineAdjusttmp_Low[WakeUpKeyValue] = BaseLineAdjusttmp[WakeUpKeyValue];//(TKCFG1 & 0X80) | BaseLineA
             -djusttmp[WakeUpKeyValue];
 698   2            CurrentChannel_Low[WakeUpKeyValue] =  0xc0|CurrentChannel[WakeUpKeyValue];
 699   2      
 700   2            SetFingerThresholdtmp_Low[WakeUpKeyValue] = TKChannelCfg[WakeUpKeyValue][FINGER_THRESHOLD_H]*256+TKChan
             -nelCfg[WakeUpKeyValue][FINGER_THRESHOLD_L];        
 701   2      
 702   2            TKCFG0 &= 0XF0;
 703   2            TKCFG0 |= TKChannelCfg[0][SET_TOUCH_FREQ];
 704   2          }
 705   1      }
 706          
 707          /**************************************************
 708          *º¯ÊýÃû³Æ£ºvoid TouchKey_IntoLowPowerMode(void)
 709          *º¯Êý¹¦ÄÜ£d½øÈëµÍ¹¦ºÄÄ£Ê½
 710          *Èë¿Ú²ÎÊý£ºvoid
 711          *³ö¿Ú²ÎÊý£ºvoid  
 712          **************************************************/
 713          void TouchKey_IntoLowPowerMode(void)
 714          {
 715   1          #ifdef  TK_LowPowerMode
 716   1        unsigned char t;
 717   1          LowPowerScan_Flag = 1;
 718   1      
 719   1        ScanTimeTemp0 = ScanTime >> ScanTimeCon;
 720   1          Customer_IntoLowPowerMode_Init();
 721   1      
 722   1          TouchKey_LowPower_Init();
 723   1         
 724   1        for(t=0;t<CurrentChannelMax;t++)
 725   1        {
 726   2           TouchCnt[t] = 0;
 727   2        }
 728   1          #endif
 729   1      }
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 13  

 730          
 731          #ifdef  TK_LowPowerMode
 732          /**************************************************
 733          *º¯ÊýÃû³Æ£ºvoid TouchKey_QuitLowPowerMode(void)
 734          *º¯Êý¹¦ÄÜ£dÍË³öµÍ¹¦ºÄÄ£Ê½
 735          *Èë¿Ú²ÎÊý£ºvoid
 736          *³ö¿Ú²ÎÊý£ºvoid  
 737          **************************************************/
 738          void TouchKey_QuitLowPowerMode(void)
 739          {
 740   1         LowPowerScan_Flag = 0;
 741   1           WakeUp_Flag = 1;
 742   1         
 743   1           TKCR = 0x80|CurrentChannel[0];
 744   1         TKTM = ScanTime*TKChannelCfg[0][SCANTIME]>>3; 
 745   1           TK_IE1 = TK_IE1&(~0x10);       //¹Ø±ÕTKÖÐ¶Ï
 746   1         TRIG = 1;
 747   1         while(TRIF == 0);  
 748   1         TRIF = 0;
 749   1         TK_IE1 = TK_IE1|0x10;            //Ê¹ÄÜTKÖÐ¶Ï
 750   1           TRIG = 1; 
 751   1           Customer_QuitLowPowerMode_Init();
 752   1      }
 753          
 754          
 755          
 756          
 757          /**************************************************
 758          *º¯ÊýÃû³Æ£ºvoid TouchKey_LowPower_Dispose(void)
 759          *º¯Êý¹¦ÄÜ£dµÍ¹¦ºÄÉ¨ÃèÊý¾Ý´¦Àí
 760          *Èë¿Ú²ÎÊý£ºvoid
 761          *³ö¿Ú²ÎÊý£ºvoid  
 762          **************************************************/
 763          void TouchKey_LowPower_Dispose(void)
 764          {  
 765   1        int data differData; 
 766   1      
 767   1        unsigned char data WakeUpKey_Index;
 768   1      
 769   1        
 770   1        BTM_WakeUpFlag = 0;
 771   1      
 772   1        TRIG = 1;
 773   1          PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 774   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 775   1          _nop_();
 776   1          _nop_();
 777   1          _nop_();
 778   1          _nop_();
 779   1          _nop_();
 780   1          _nop_();
 781   1        _nop_();
 782   1      
 783   1          TRIG = 1;
 784   1          PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 785   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 786   1          _nop_();
 787   1          _nop_();
 788   1          _nop_();
 789   1          _nop_();
 790   1          _nop_();
 791   1          _nop_();
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 14  

 792   1        _nop_();
 793   1        
 794   1          
 795   1        for(WakeUpKey_Index=0; WakeUpKey_Index<WakeUpKeyNum; WakeUpKey_Index++)
 796   1        {
 797   2      
 798   2              WakeUpKeyValue = WakeUpKey_List[WakeUpKey_Index];
 799   2          TKCFG1 =  BaseLineAdjusttmp_Low[WakeUpKeyValue]; 
 800   2          TKTM = ScanTimeTemp_Low[WakeUpKeyValue];//ScanTimeTemp;
 801   2          TKCR = CurrentChannel_Low[WakeUpKeyValue];
 802   2      
 803   2              PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 804   2            _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 805   2              _nop_();
 806   2              _nop_();
 807   2              _nop_();
 808   2              _nop_();
 809   2              _nop_();
 810   2              _nop_();
 811   2            _nop_();       
 812   2      
 813   2              differData = (TKCNT<<ScanTimeCon)-BaseLine[WakeUpKeyValue] ; 
 814   2        
 815   2          if(differData >= SetFingerThresholdtmp_Low[WakeUpKeyValue])
 816   2            {
 817   3             SingleKeyFastScan_Flag = 1;
 818   3             break;       
 819   3            } 
 820   2      
 821   2               if(WakeUpNum==WakeUpKey_Index)
 822   2                  BaseLine[WakeUpKeyValue] += differData>>2;
 823   2        }
 824   1      
 825   1      
 826   1        if(++WakeUpNum>=BaselineUpdateCnt)
 827   1        {
 828   2          WakeUpNum = 0;
 829   2        }
 830   1      }
 831            
 832          /**************************************************
 833          *º¯ÊýÃû³Æ£ºvoid SingleKeyFastScan(void)
 834          *º¯Êý¹¦ÄÜ£dµ¥°´¼ü¿ìËÙÉ¨ÃèÄ£Ê½
 835          *Èë¿Ú²ÎÊý£ºvoid
 836          *³ö¿Ú²ÎÊý£ºvoid  
 837          **************************************************/
 838          void SingleKeyFastScan(void)
 839          { 
 840   1          unsigned char i;
 841   1          int differData; 
 842   1          int SetFingerThresholdtmp;
 843   1        
 844   1        SingleKeyFastScan_Flag = 0;
 845   1        TK_IE1 = TK_IE1|0x10; //´ò¿ªTKÖÐ¶Ï
 846   1        TKCFG1 = (TKCFG1 & 0X80) | BaseLineAdjusttmp[WakeUpKeyValue];
 847   1          TKCR = 0x80|CurrentChannel[WakeUpKeyValue]; 
 848   1        TKTM = ScanTimeTemp0*TKChannelCfg[WakeUpKeyValue][SCANTIME];
 849   1        
 850   1        for(i=0;i<TK_WakeUpConfirmTouchCnt;i++)
 851   1        {     
 852   2        
 853   2           TRIG = 1;
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 15  

 854   2           TKSleepMode();
 855   2           RawData[WakeUpKeyValue] = TKCNT << ScanTimeCon;
 856   2           FilterDataDeal(WakeUpKeyValue);
 857   2               differData = RawData[WakeUpKeyValue]-BaseLine[WakeUpKeyValue] ;
 858   2           SetFingerThresholdtmp = GetCurrFingerValue(WakeUpKeyValue);
 859   2      
 860   2           if(differData >= SetFingerThresholdtmp )
 861   2           {   
 862   3              TouchCnt[WakeUpKeyValue]++;  
 863   3           }             
 864   2           else
 865   2           {
 866   3            break;
 867   3           }
 868   2        }
 869   1        
 870   1          if(TouchCnt[WakeUpKeyValue]>=TK_WakeUpConfirmTouchCnt)
 871   1          {    
 872   2            AntiMisAwakeup(WakeUpKeyValue);
 873   2          }
 874   1          else
 875   1          {
 876   2              TouchCnt[WakeUpKeyValue] = 0;
 877   2          }
 878   1      }
 879          
 880          void  TKSleepMode(void)
 881          {
 882   1        PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 883   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 884   1          _nop_();
 885   1          _nop_();
 886   1          _nop_();
 887   1          _nop_();
 888   1          _nop_();
 889   1          _nop_();
 890   1        _nop_();
 891   1      }
 892          #endif
 893          /**************************************************
 894          *º¯ÊýÃû³Æ£ºvoid LowPower_Touchkey_Scan(void)
 895          *º¯Êý¹¦ÄÜ£dµÍ¹¦ºÄÄ£Ê½TKÉ¨Ãè
 896          *Èë¿Ú²ÎÊý£ºvoid
 897          *³ö¿Ú²ÎÊý£ºvoid  
 898          **************************************************/
 899          
 900          void LowPower_Touchkey_Scan(void)
 901          {               
 902   1        #ifdef  TK_LowPowerMode 
 903   1          unsigned char TEMP = 0;
 904   1          EA  = 0;
 905   1          OPINX = 0XC1;
 906   1          TEMP = OPREG;
 907   1          OPREG &= 0XCF;
 908   1          OPREG |= 0X10;
 909   1          
 910   1          TKCR &= 0x7f;//~0x80;
 911   1          EA  = 1;
 912   1          
 913   1        PCON = 0x02;  //PCONµÄbit1 STOPÎ»Ð´1£¬ÅäÖÃMCU½øÈëSTOPÄ£Ê½
 914   1        _nop_();    //ÖÁÉÙÐèÒª8¸ö_nop_()
 915   1          _nop_();
C51 COMPILER V9.60.0.0   S_TOUCHKEYCFG                                                     04/25/2023 10:52:14 PAGE 16  

 916   1          _nop_();
 917   1          _nop_();
 918   1          _nop_();
 919   1          _nop_();
 920   1          _nop_();
 921   1        _nop_();
 922   1          
 923   1          OPINX =  0XC1;
 924   1          OPREG = TEMP;
 925   1          
 926   1        TKCR |= 0x80; //´ò¿ªTKµçÔ´
 927   1      
 928   1        //½øÐÐ°´¼ü´¦Àí
 929   1        if(BTM_WakeUpFlag)
 930   1        {
 931   2          TouchKey_LowPower_Dispose();       //¼ì²â°´¼ü 
 932   2          CLRWDT();
 933   2          if( SingleKeyFastScan_Flag == 1)
 934   2          {                  
 935   3            SingleKeyFastScan();       //ÈôÓÐ°´¼üÐÅÏ¢½øÈëµ¥°´¼ü¿ìËÙ¶à´ÎÉ¨ÃèÈ·¶¨°´¼üÊÇ·ñÕæÊµÐÅºÅ¡£
 936   3          }
 937   2          LowPowerAwakeupDispose();
 938   2        }
 939   1        #endif    
 940   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2032    ----
   CONSTANT SIZE    =    130    ----
   XDATA SIZE       =    220      18
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     48       3
   IDATA SIZE       =     13    ----
   BIT SIZE         =      6    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
